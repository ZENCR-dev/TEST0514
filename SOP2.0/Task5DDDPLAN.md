# Task 5 DDD实施计划 - 精简执行版

**文档版本：** 1.0 - **专注可执行任务清单**  
**创建日期：** 2025年6月19日  
**项目：** 新西兰中医药电子处方平台 MVP 1.0  
**文档定位：** 核心任务"作战地图" - 可执行任务清单  

---

## 📊 任务执行总览

| Task | 服务名称 | 完成度 | 状态 | 剩余工作量 | 优先级 |
|------|---------|--------|------|------------|---------|
| **5A** | 订单实体管理服务 | **75%** | API层缺失 | 1-2天 | P1 |
| **5B** | 支付引擎服务 | **77%** | 3个核心方法待实现 | 3-5天 | P0 |
| **5C** | 业务编排服务 | **0%** | 完全未开始 | 4-6天 | P0 |

**总体DDD架构完成度：** 51% → 目标：100%  
**当前聚焦：** 优先完成Task 5A/B，然后研究5C技术方案

---

## 🎯 Task 5A: OrderController实现 (1-2天)

### ❌ 缺失组件
- OrderController：0%实现，5个API端点全部缺失
- OrdersModule：模块集成配置缺失
- 路由注册：app.module.ts未导入

### ✅ 执行清单

#### Day 1: Controller实现 (8小时)
- [ ] **创建OrderController** `src/orders/orders.controller.ts`
  - [ ] 基础Controller结构 + 依赖注入
  - [ ] 5个CRUD端点：POST、GET、GET/:id、PUT/:id/status、DELETE/:id
  - [ ] @Auth()和@Permissions()权限控制
  - [ ] Swagger文档注解

#### Day 2: 模块集成 (8小时)  
- [ ] **创建OrdersModule** `src/orders/orders.module.ts`
  - [ ] providers/controllers/exports配置
  - [ ] 在app.module.ts中导入注册
- [ ] **API测试验证**
  - [ ] 单元测试（≥90%覆盖率）
  - [ ] 集成测试（端到端流程）
  - [ ] Swagger文档验证

### 🎯 验收标准
- [ ] 所有5个API端点正常响应
- [ ] 权限控制工作正常
- [ ] 单元测试覆盖率≥90%
- [ ] 集成测试通过

---

## 💳 Task 5B: PaymentService补全 (3-5天)

### ❌ 缺失的P0关键方法
1. **confirmPayment()** - 支付确认（P0）
2. **deductFromClinicAccount()** - 诊所账户扣款（P0）  
3. **refundToClinicAccount()** - 账户退款（P1）

### ✅ 执行清单

#### Day 1: confirmPayment实现 (8小时)
- [ ] **Stripe API集成**
  - [ ] Payment Intent confirm API调用
  - [ ] 支付状态处理（requires_action, succeeded, failed）
  - [ ] 事件发射：payment.confirmed/payment.failed

#### Day 2-3: deductFromClinicAccount实现 (16小时)
- [ ] **数据验证**
  - [ ] 账户余额查询验证
  - [ ] 扣款金额验证（正数、精度）
  - [ ] 权限验证（诊所ID匹配）
- [ ] **并发控制**
  - [ ] 乐观锁实现
  - [ ] 事务边界设计
  - [ ] 并发冲突处理
- [ ] **审计机制**
  - [ ] 扣款操作日志
  - [ ] 余额变更历史
  - [ ] 监控集成

#### Day 4: refundToClinicAccount实现 (8小时)
- [ ] **退款逻辑**
  - [ ] 账户余额增加
  - [ ] 退款记录创建
  - [ ] 重复退款检测

#### Day 5: 综合测试 (8小时)
- [ ] **压力测试**
  - [ ] 1000并发扣款测试
  - [ ] 数据一致性验证
  - [ ] 性能基准（P95≤200ms）

### 🎯 验收标准
- [ ] confirmPayment：支持所有Stripe状态
- [ ] deductFromClinicAccount：1000并发无数据不一致
- [ ] refundToClinicAccount：与现有流程集成
- [ ] 单元测试覆盖率100%

---

## 🎼 Task 5C: 业务编排服务 (待技术方案确定)

### 🚨 关键问题
系统当前状态："有器官无神经系统"
- PaymentService发射事件，但无监听者
- 支付成功后订单状态无法自动更新
- 缺乏业务流程自动化

### 📋 任务定义
**执行优先级：** P0（在Task 5A/B完成后启动）  
**技术方案：** 待Task 5A/B完成后深入研究确定  
**预估复杂度：** 高（需要处理分布式事务和服务协调）

### 🎯 核心业务需求
- [ ] **支付成功事件处理**：支付完成后自动更新订单状态
- [ ] **支付失败事件处理**：支付失败时自动执行状态回滚
- [ ] **订单状态同步**：确保订单和支付状态保持一致
- [ ] **异常恢复机制**：处理各种异常情况的自动恢复

### 📝 技术研究清单（Task 5A/B完成后执行）
- [ ] **技术方案调研**：评估不同的业务编排实现方案
- [ ] **架构设计**：确定服务间通信和事件处理机制
- [ ] **风险评估**：识别分布式事务相关的技术风险
- [ ] **实施计划**：制定详细的开发和测试计划

### 🎯 最终验收标准（技术无关）
- [ ] 支付成功后订单状态自动更新为PAID
- [ ] 支付失败时订单状态正确回滚
- [ ] 系统在各种异常情况下能够正确恢复
- [ ] 业务流程端到端自动化运行

---

## ⏱️ 开发时间线

### 🎖️ 关键里程碑

#### M1 (1周后): 服务层补全完成
**目标日期：** 2025年6月26日
- [ ] Task 5A: OrderController API完全可用
- [ ] Task 5B: 3个核心方法实现完成
- [ ] 服务层集成测试通过

#### M2 (2周后): Task 5C技术方案确定
**目标日期：** 2025年7月3日  
- [ ] Task 5C技术架构深入研究完成
- [ ] 技术方案选型和风险评估完成
- [ ] Task 5C详细实施计划制定

#### M3 (3周后): DDD架构验收
**目标日期：** 2025年7月10日
- [ ] Task 5C业务编排服务实现完成
- [ ] DDD三层架构完整性验证
- [ ] 系统集成测试通过

---

## 🚨 应急预案

### 🔴 优先级调整方案
如开发进度滞后：
- **Phase 1**: 完成Task 5A + 5B（核心功能）
- **Phase 2**: Task 5C简化实现（基础事件监听）
- **Phase 3**: 复杂编排逻辑（可推迟至MVP 2.0）

### 🔴 技术简化方案
如EventEmitter复杂度超预期：
- **简化版本**: 直接在PaymentService中调用OrderService
- **时间节省**: 2-3天
- **功能保证**: 基础业务流程正常

---

## 📋 最终验收标准

### DDD三层架构完整性
- [ ] **订单实体层**：OrderService + OrderController 100%实现
- [ ] **支付引擎层**：PaymentService 3个核心方法100%实现  
- [ ] **业务编排层**：技术方案确定后实现业务编排服务

### 业务流程自动化
- [ ] **正常流程**：订单创建→支付→状态更新（全自动）
- [ ] **异常处理**：支付失败→状态回滚（自动恢复）
- [ ] **取消流程**：订单取消→退款触发（自动处理）

### 技术指标达标
- [ ] **响应时间**：P95≤200ms, P99≤500ms
- [ ] **并发能力**：1000+并发无数据不一致
- [ ] **测试覆盖**：核心服务≥95%，支付相关100%
- [ ] **系统可用性**：≥99.9%

---

*文档类型：可执行任务清单*  
*更新策略：任务完成后更新进度*  
*下次更新：M1里程碑达成后*

**🗺️ Task5DDDPLAN - 专注执行，驱动结果** 🚀 