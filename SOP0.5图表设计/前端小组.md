作为前端Leader，我已经仔细评审了SOP 0.5，现在提供三个关键的Markdown图表，以支持前后端高效协作和开发。

## 1. 前后端数据交互格式表

| 页面/组件 | 功能模块 | API端点 | HTTP方法 | 请求格式 | 响应格式 | 错误处理 | 加载状态 | 优先级 |
|----------|----------|---------|----------|----------|----------|----------|----------|--------|
| 登录页面 | 用户认证 | `/api/v1/auth/login` | POST | `{email: string, password: string}` | `{user: UserProfile, tokens: {accessToken, refreshToken, expiresIn}}` | 表单验证+全局错误提示 | 登录按钮Loading | P0 |
| 注册页面 | 用户认证 | `/api/v1/auth/register` | POST | `{email, password, role, profile: {name, clinic?, pharmacy?}}` | `{user: UserProfile, tokens: TokenPair}` | 字段级验证+全局提示 | 注册按钮Loading | P0 |
| Token刷新 | 用户认证 | `/api/v1/auth/refresh` | POST | `{refreshToken: string}` | `{accessToken: string, expiresIn: number}` | 静默重试+登出 | 静默处理 | P0 |
| 用户信息 | 用户管理 | `/api/v1/users/profile` | GET | `headers: {Authorization}` | `{id, email, role, profile, createdAt}` | 权限错误处理 | Skeleton加载 | P0 |
| 药品搜索 | 药品管理 | `/api/v1/medicines` | GET | `{q?: string, page: number, limit: number, sort?: string}` | `{data: Medicine[], meta: PaginationMeta}` | 空状态+搜索错误 | 搜索Loading+列表Skeleton | P0 |
| 药品详情 | 药品管理 | `/api/v1/medicines/:id` | GET | `path: {id: string}` | `{id, chineseName, englishName, pinyinName, price, description}` | 404处理+重试 | 详情页Skeleton | P1 |
| 处方创建 | 核心业务 | `/api/v1/prescriptions` | POST | `{items: PrescriptionItem[], patientInfo: PatientInfo, notes?: string}` | `{orderId, orderNumber, qrCode, paymentAmount, status}` | 表单验证+业务错误 | 提交Loading+禁用 | P0 |
| 处方列表 | 核心业务 | `/api/v1/prescriptions` | GET | `{page, limit, status?, dateFrom?, dateTo?}` | `{data: Prescription[], meta: PaginationMeta}` | 空状态+筛选错误 | 列表Loading+Skeleton | P0 |
| 订单详情 | 核心业务 | `/api/v1/orders/:id` | GET | `path: {id: string}` | `{order: OrderDetail, items: OrderItem[], patient: PatientInfo, clinic: ClinicInfo}` | 权限+404处理 | 详情Skeleton | P0 |
| 药房搜索 | 药房服务 | `/api/v1/pharmacies/search` | GET | `{lat: number, lng: number, radius: number, medicines?: string[]}` | `{pharmacies: PharmacyLocation[], searchCenter, searchRadius}` | 地理位置错误+空结果 | 地图Loading+列表Skeleton | P1 |
| 履约照片上传 | 文件服务 | `/api/v1/files/presigned-url` | POST | `{fileName: string, fileType: string, fileSize: number, purpose: string}` | `{uploadUrl: string, fields: object, fileId: string, expiresIn: number}` | 文件格式+大小验证 | 上传进度条 | P1 |
| 上传确认 | 文件服务 | `/api/v1/files/confirm` | POST | `{fileId: string, actualSize: number, checksum?: string}` | `{fileUrl: string, status: 'confirmed'}` | 上传失败重试 | 确认Loading | P1 |
| 订单状态更新 | 核心业务 | `/api/v1/orders/:id/status` | PATCH | `{status: OrderStatus, fulfillmentProof?: {fileIds: string[], notes: string}}` | `{order: OrderDetail, updatedAt: string}` | 状态转换验证 | 状态更新Loading | P0 |
| 通知轮询 | 通知服务 | `/api/v1/notifications/poll` | GET | `{lastPolledAt?: string, limit?: number}` | `{notifications: Notification[], unreadCount: number, lastPolledAt: string}` | 网络错误静默处理 | 后台轮询 | P1 |
| 管理员用户列表 | 管理后台 | `/api/v1/admin/users` | GET | `{page, limit, role?, status?, search?}` | `{data: AdminUserList[], meta: PaginationMeta}` | 权限检查+筛选错误 | 表格Loading | P2 |
| 履约审核 | 管理后台 | `/api/v1/admin/fulfillments/:id/review` | POST | `{decision: 'approve'|'reject', comments?: string}` | `{fulfillment: FulfillmentDetail, reviewedAt: string}` | 审核冲突处理 | 审核按钮Loading | P1 |

## 2. UI状态与后端状态映射表

| 后端状态/数据 | 前端UI状态 | 显示样式 | 用户操作 | 状态转换逻辑 | 权限控制 |
|--------------|------------|----------|----------|--------------|----------|
| **订单状态映射** | | | | | |
| `draft` | 草稿 | 灰色标签 | 编辑、删除、提交 | 可转换为pending_payment | 创建者可操作 |
| `pending_payment` | 待支付 | 橙色标签+倒计时 | 支付、取消 | 支付成功→paid，超时→cancelled | 创建者+管理员 |
| `paid` | 已支付 | 绿色标签 | 查看详情、联系药房 | 药房操作后→dispensing | 只读，除药房操作 |
| `dispensing` | 配药中 | 蓝色标签+进度指示 | 药房:提交履约证明 | 提交证明→under_review | 药房可操作 |
| `under_review` | 审核中 | 黄色标签 | 管理员:审核 | 审核通过→fulfilled，拒绝→dispensing | 管理员可审核 |
| `fulfilled` | 已完成 | 深绿色标签+完成图标 | 评价、查看详情 | 终态，可申请售后 | 只读 |
| `cancelled` | 已取消 | 红色标签 | 查看取消原因 | 终态 | 只读 |
| **用户认证状态** | | | | | |
| `authenticated` | 已登录 | 显示用户头像+角色 | 访问授权页面 | token过期→unauthenticated | 基于角色显示功能 |
| `unauthenticated` | 未登录 | 显示登录按钮 | 只能访问公开页面 | 登录成功→authenticated | 公开功能only |
| `token_expired` | 令牌过期 | 显示重新登录提示 | 自动刷新或重新登录 | 刷新成功→authenticated | 受限访问 |
| `loading` | 认证检查中 | 显示认证Loading | 禁用所有操作 | 检查完成→对应状态 | 等待状态 |
| **文件上传状态** | | | | | |
| `selecting` | 选择文件 | 上传区域高亮 | 选择/拖拽文件 | 文件选中→validating | 上传权限检查 |
| `validating` | 文件验证中 | 验证进度条 | 等待验证结果 | 验证通过→uploading | 格式大小检查 |
| `uploading` | 上传中 | 上传进度条+百分比 | 取消上传 | 上传完成→confirming | 显示上传速度 |
| `confirming` | 确认中 | 确认状态指示器 | 等待确认 | 确认完成→completed | 等待后端确认 |
| `completed` | 上传完成 | 绿色成功图标 | 预览、删除 | 可重新上传 | 文件管理权限 |
| `failed` | 上传失败 | 红色错误图标+错误信息 | 重试上传 | 重试→uploading | 显示错误详情 |
| **药房营业状态** | | | | | |
| `open` | 营业中 | 绿色圆点+"营业中" | 可下单 | 时间到→closed | 显示营业时间 |
| `closed` | 休息中 | 灰色圆点+"休息中" | 禁止下单 | 营业时间→open | 显示开店时间 |
| `busy` | 繁忙 | 黄色圆点+"繁忙" | 可下单但有延迟提示 | 订单减少→open | 显示预计等待时间 |
| `unavailable` | 暂停服务 | 红色圆点+"暂停服务" | 禁止下单 | 管理员恢复→open | 显示暂停原因 |
| **支付状态** | | | | | |
| `pending` | 支付处理中 | 支付Loading动画 | 等待支付结果 | 成功→completed，失败→failed | 禁用重复支付 |
| `completed` | 支付成功 | 绿色成功图标 | 查看支付详情 | 终态 | 显示支付凭证 |
| `failed` | 支付失败 | 红色失败图标+错误信息 | 重新支付、选择其他方式 | 重试→pending | 显示失败原因 |
| `refunded` | 已退款 | 蓝色退款图标 | 查看退款详情 | 终态 | 显示退款信息 |

## 3. 文件上传处理流程表

| 阶段 | 前端操作 | API调用 | 后端处理 | 成功响应 | 失败处理 | 用户反馈 | 安全检查 |
|------|----------|---------|----------|----------|----------|----------|----------|
| **1. 文件选择** | 用户选择文件/拖拽 | 无 | 无 | 文件对象获取 | 文件格式错误提示 | 文件预览显示 | 前端格式验证 |
| **2. 预验证** | 检查文件大小、格式 | 无 | 无 | 验证通过 | 阻止上传+错误提示 | 验证进度指示 | 大小限制1MB，格式白名单 |
| **3. 获取预签名URL** | `fetch('/api/v1/files/presigned-url')` | `POST /api/v1/files/presigned-url` | 生成Supabase签名URL | `{uploadUrl, fields, fileId, expiresIn}` | 网络错误重试 | "准备上传..."Loading | JWT验证+权限检查 |
| **请求体** | `{fileName, fileType, fileSize, purpose}` | 接收并验证请求参数 | 调用Supabase Storage API | 签名URL生成成功 | 参数验证失败返回400 | 参数错误提示 | 文件用途验证 |
| **4. 文件上传** | 使用预签名URL直传Supabase | 直接请求Supabase Storage | Supabase处理文件存储 | HTTP 200 上传成功 | 上传失败重试机制 | 实时进度条显示 | HTTPS加密传输 |
| **上传配置** | `FormData`包含文件+fields | 无后端参与 | Supabase验证签名 | 文件存储到指定bucket | 签名过期/无效错误 | 上传速度显示 | 签名时效性验证 |
| **5. 上传确认** | `fetch('/api/v1/files/confirm')` | `POST /api/v1/files/confirm` | 验证文件并记录元数据 | `{fileUrl, status: 'confirmed'}` | 文件损坏/不存在错误 | "上传完成"成功提示 | 文件完整性检查 |
| **确认请求** | `{fileId, actualSize, checksum?}` | 查询Supabase文件信息 | 更新数据库文件记录 | 文件元数据入库 | 数据库操作失败 | 确认状态指示器 | 文件大小一致性验证 |
| **6. 业务关联** | 调用业务API关联文件 | 如`PATCH /api/v1/orders/:id` | 将fileId关联到业务实体 | 业务记录更新成功 | 业务关联失败 | 文件关联成功提示 | 业务权限验证 |
| **关联示例** | `{fulfillmentProof: {fileIds: [fileId]}}` | 验证文件ownership | 更新订单履约证明 | 订单状态可能变更 | 权限不足错误 | 履约证明上传成功 | 文件归属权检查 |
| **7. 错误恢复** | 检测失败阶段并重试 | 对应失败阶段的API | 幂等性处理重复请求 | 从失败点继续 | 超过重试次数放弃 | 明确的错误信息 | 重试次数限制 |
| **清理机制** | 定时清理未确认文件 | 定时任务扫描 | 删除过期未确认文件 | 存储空间释放 | 清理失败记录日志 | 用户无感知 | 过期文件安全删除 |
| **权限控制** | JWT Token携带在Header | 每个API验证token | 基于角色和资源检查权限 | 权限通过 | 401/403错误 | 权限不足提示 | 细粒度权限控制 |
| **监控告警** | 前端错误上报 | 后端记录操作日志 | 监控上传成功率 | 正常运行 | 异常告警触发 | 必要时用户通知 | 安全事件监控 |

## 前端开发要点总结

基于以上表格设计，作为前端Leader，我特别强调以下几个关键点：

### 1. **API集成优先级**
- **P0 APIs**: 认证、处方创建/查询、订单管理 - 必须在Phase 1完成
- **P1 APIs**: 药房搜索、文件上传、通知轮询 - Phase 1后期完成
- **P2 APIs**: 管理后台功能 - 可延后至Phase 2

### 2. **状态管理策略**
- 使用Zustand管理全局状态（认证、购物车、通知）
- 使用React Query管理API状态（缓存、同步、错误处理）
- 订单状态变化需要实时更新UI反馈

### 3. **用户体验优化**
- 所有异步操作都有Loading状态和Skeleton
- 错误处理分层：网络错误、业务错误、验证错误
- 文件上传提供详细进度和取消功能

### 4. **安全性考虑**
- JWT Token自动刷新机制
- 文件上传使用预签名URL避免直接暴露存储密钥
- 敏感操作需要二次确认

这些表格将作为前后端协作的重要参考文档，确保我们能够高效、一致地实现MVP 1.0的核心功能。