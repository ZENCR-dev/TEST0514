这份 SOP 0.5 将是 **后端 Leader 主导下，综合各方意见形成的、具备最低可执行性的技术方案和操作规程**。它将明确技术选型、架构定型、功能/组件拆分，并特别指出每个部分在 MVP 1.0 开发阶段需要攻克的**核心问题**，为后续后端小组内部的模块化敏捷开发提供清晰的起点和方向。

我将确保 SOP 0.5 体现以下关键点：

1.  **决策的落地：** 根据架构师的强烈建议和团队的普遍共识，明确最终的技术栈选择（如 NestJS + Prisma + Supabase）。
2.  **架构的整合与简化：** 采纳架构师关于服务架构精简的建议，明确核心服务模块及其职责。
3.  **设计文档的采纳：** 将架构师提供的数据库设计、API 规范和部署架构作为 SOP 的核心组成部分或重要参考。
4.  **产品与前端需求的融入：** 确保产品经理关注的核心业务流程、支付风险控制、市场推广支持，以及前端 Leader 关注的 API 细节、认证流程、文件处理、实时性等得到充分体现和规划。
5.  **聚焦核心攻关问题：** 对于每个模块或组件，不再是泛泛的功能描述，而是提出在 MVP 1.0 实现过程中需要解决的关键技术挑战或设计决策点。
6.  **可执行性：** 文档将以指导后端团队实际启动 Phase 1 开发为目标，明确“做什么”和“需要重点思考什么”。

我现在开始整合信息并撰写 SOP 0.5。这需要一些时间来仔细梳理所有输入并确保其内部一致性和可操作性。

---

**SOP 0.5：新西兰中医处方平台 - MVP 1.0 后端开发标准操作规程 (综合决策版)**

**文档版本：** 0.5
**日期：** [当前日期]
**负责人：** [我的名字/AI助手] (后端 Leader)
**核心贡献者：** 总监架构师、产品/市场经理、前端 Leader

**1. 项目概述与 MVP 1.0 目标**

*   **1.1. 项目愿景:** (同 SOP 0.2) 为新西兰中医师提供一个现代化的电子处方及草药调配协作平台，解决当前运营痛点，提升效率。
*   **1.2. MVP 1.0 核心功能范围 (已确认):**
    *   **核心业务闭环:** 医生开方 -> 患者支付凭证 (通过诊所预付/信用额度模式，平台生成有效凭证) -> 药房扫码/验证凭证并履约 -> 平台与药房结算。
    *   **关键支撑功能:**
        *   **P1-P2 订单信息验证 API:** 药房端履约前，后端需通过此 API 验证平台订单的真实性与核心信息。
        *   **患者端药房查找 API:** 支持患者根据地理位置和（非实时）药品供应能力查找合作药房。
        *   **基础管理员功能 API:** 支持查看用户列表、药品目录、药房列表；支持手动审核药房履约凭证。
        *   **医生推荐机制后端支持。**
        *   **医师处方模板 CRUD 后端支持。**
    *   **明确排除/降级 (MVP 1.0):** AI 辅助审核（采用管理员手动审核）。
*   **1.3. MVP 1.0 预期上线评测目标与衡量标准:**
    *   **核心 KPIs (由产品经理细化):** 医生用户增长与活跃度 (注册数、月活开方医师、月处方量/金额)、药房合作与履约效率 (合作数、月处理处方量、履约耗时)、患者体验指标 (药房查找使用率、订单履约率)、平台核心财务表现 (毛利、营收、盈亏平衡点追踪)。
    *   成功上线并稳定运行核心业务流程，收集至少 [N] 位医生和 [M] 家药房的初步使用反馈。

**2. 技术架构与选型 (最终决策)**

*   **2.1. 整体架构:** **Hybrid - Supabase for Data/Auth/Storage, Dedicated Backend for API/Logic.**
    *   *架构图参考 `MVP 1.0 部署架构设计.md` 中的整体拓扑，并结合服务模块进行细化。*
*   **2.2. 后端技术栈:**
    *   **语言/框架:** **Node.js + NestJS (TypeScript)**
    *   **数据库:** **Supabase PostgreSQL** (初期采用 Supabase Cloud Pro Plan 或更高，以保障SLA和运维支持)
    *   **ORM:** **Prisma**
    *   **认证:** **Supabase Auth** (JWTs，由 Dedicated Backend 统一封装和管理)
    *   **文件存储:** **Supabase Storage** (通过 Backend 生成签名 URL 控制访问)
    *   **API 类型:** **RESTful API** (遵循 OpenAPI 规范 v3.x)
*   **2.3. 部署方案:**
    *   **Frontend:** Vercel/Netlify
    *   **Dedicated Backend (NestJS):** Dockerized application, 部署于 **Render.com (推荐)** 或 Fly.io。采用其提供的负载均衡和自动伸缩能力。
    *   **Supabase:** Supabase Cloud。
    *   *详细部署策略参考 `MVP 1.0 部署架构设计.md`。*
*   **2.4. 核心设计原则:** API First, Stateless Backend Services, Security by Design, Privacy by Design, Modularity, Testability.

**3. 核心后端服务/模块定义与核心攻关问题 (MVP 1.0)**

*架构师建议的4个核心服务架构为指导，内部可进一步细化逻辑模块。*

*   **3.1. User & Auth Service (用户与认证服务)**
    *   **职责:** 统一用户身份管理（医师、药房操作员、管理员、未来患者）、JWT 认证与授权、角色管理、Profile 管理、医生推荐码逻辑。
    *   **核心攻关问题 (MVP 1.0):**
        *   如何安全、高效地集成 Supabase Auth，并在 NestJS 中实现统一的 JWT 签发、校验和刷新机制？
        *   如何设计灵活且易于扩展的 RBAC (Role-Based Access Control) 机制，确保 API 权限精确控制？
        *   医生推荐码的生成、验证和关联逻辑如何实现？
    *   **开源利用:** Passport.js (`passport-jwt`), `jsonwebtoken`, `class-validator` (for DTOs), Supabase JS SDK.

*   **3.2. Core Business Service (核心业务服务)**
    *   **职责:** 承载平台最核心的交易流程，包括处方管理、订单/凭证生命周期管理、药房报价与履约处理、支付流程编排、与各方（诊所、药房）的结算逻辑。
    *   **核心攻关问题 (MVP 1.0):**
        *   **处方/订单状态机设计与实现：** 如何清晰定义各状态（Draft, Pending Payment, Paid, Dispensing, Fulfilled, Cancelled）及其转换条件、触发动作和权限？
        *   **支付流程与资金流转（诊所预付/信用额度模式）：**
            *   如何设计诊所信用额度/预付款账户体系？
            *   如何实现订单生成时实时、可靠地扣除诊所额度/预付款，并与凭证有效性严格绑定？
            *   平台与药房的结算逻辑（基于C价）如何准确、高效地处理？
        *   **P1-P2 订单信息验证机制：** 如何设计和实现 Backend 调用 Platform 1 (假设为自身另一个受保护的 API 端点或特定逻辑) 进行订单信息核实的流程和安全机制？
        *   **事务管理：** 在创建订单、处理支付、更新库存（药房侧，平台记录）等关键操作中，如何保证数据的一致性（ACID）？(Prisma 的 `$transaction` API 是关键)
        *   **药房履约凭证的手动审核流程设计：** 管理员如何高效审核，审核标准是什么，审核结果如何影响订单和结算状态？
    *   **开源利用:** Prisma (for transactions), QR code generation library (e.g., `qrcode`), PDF generation library (e.g., `pdf-lib`).

*   **3.3. External Integration Service (外部集成服务)**
    *   **职责:** 作为所有第三方服务的统一网关和适配层，包括支付网关、邮件/SMS 服务、地图服务。
    *   **核心攻关问题 (MVP 1.0):**
        *   **支付网关集成 (e.g., Stripe):** 如何安全、可靠地集成支付API，处理支付意图、支付成功/失败回调、退款（基础）？Webhook 的安全性和幂等性如何保证？
        *   **邮件/SMS 服务集成:** 如何设计可配置的通知模板，并实现可靠的异步发送？
        *   **错误处理与韧性:** 如何为第三方 API 调用设计统一的错误处理、重试、超时和降级策略（例如，支付服务暂时不可用时的用户提示和后续处理）？
    *   **开源利用:** 官方 SDKs (Stripe, SendGrid, etc.), HTTP clients (Axios), `Nodemailer`.

*   **3.4. Supporting Services & Shared Modules (由核心服务调用或作为共享模块)**
    *   **Medicine/PIM Service (药品信息管理):**
        *   **职责:** 药品目录的 CRUD (管理员操作)，医师端药品搜索（支持模糊查询、分页、排序）。
        *   **核心攻关问题:** 如何设计高效的药品搜索查询（考虑中英文、拼音）？药品价格（成本价、平台建议零售价）如何管理和更新？
    *   **Pharmacy Service (药房管理与查找):**
        *   **职责:** 管理合作药房信息，提供患者端药房查找 API（基于地理位置、药品供应能力 - 非实时库存）。
        *   **核心攻关问题:** 地理位置查询的效率和准确性？药房药品供应能力的数据如何维护和更新（初期可能依赖管理员手动配置或药房提报）？
    *   **File Management Module (集成在相关服务中或作为独立工具类):**
        *   **职责:** 使用 Supabase Storage 生成签名 URL，处理文件元数据。
        *   **核心攻关问题:** 如何确保签名 URL 的安全性和时效性？文件与业务实体（如履约凭证与订单）的关联如何管理？
    *   **Notification Module (集成在相关服务中或作为独立工具类):**
        *   **职责:** 封装通知发送逻辑。
        *   **核心攻关问题:** MVP 1.0 如何以最简方式实现关键事件的邮件通知（如订单状态变更、支付成功）？
    *   **Admin Support Module (API for Admin Portal):**
        *   **职责:** 提供管理后台所需的各类数据查询和操作接口。
        *   **核心攻关问题:** 如何设计灵活且安全的管理员操作 API，同时避免与核心业务服务逻辑过度耦合？
    *   **Basic Reporting Module (API for Admin Portal & Doctor Dashboard):**
        *   **职责:** 提供计算和查询核心 KPI 的 API。
        *   **核心攻关问题:** 如何高效地从业务数据中聚合生成报表所需数据？哪些基础报表对 MVP 运营最关键？

**4. 数据库设计 (Supabase PostgreSQL)**

*   **核心依据:** 采纳并细化 `MVP 1.0 核心数据库表结构设计.md`。
*   **核心攻关问题 (MVP 1.0):**
    *   **最终确认各表字段、类型、约束和关系，** 特别是 `orders` 表的状态流转字段、支付相关字段、与诊所/药房的结算关联字段。
    *   **索引优化:** 针对核心查询场景（如订单查询、药品搜索、药房查找）设计并验证索引的有效性。
    *   **RLS 策略的具体实现:** 针对关键表（`orders`, `user_profiles`）编写并测试 RLS 策略，与 Backend 的 RBAC 形成纵深防御。
    *   **敏感数据加密方案落地:** 确定哪些字段需要应用层加密，并选择加密算法和密钥管理方式（MVP 初期可简化）。
    *   **数据迁移脚本的编写与测试:** 使用 Prisma Migrate 保证 Schema 变更的可追溯和可重复性。

**5. API 设计与规范**

*   **核心依据:** 采纳并细化 `MVP 1.0 API设计规范和核心端点.md`。
*   **核心攻关问题 (MVP 1.0):**
    *   **完成核心业务流程的 OpenAPI 规范 v1.0 详细设计**，并与前端团队、产品经理评审确认。
    *   **统一错误处理机制的实现：** 在 NestJS 中建立全局异常过滤器，确保所有 API 错误响应格式一致。
    *   **DTO (Data Transfer Objects) 的设计与验证：** 使用 `class-validator` 和 `class-transformer` 严格定义和验证 API 的请求/响应体。
    *   **认证与授权在 API 层面如何通过 Guard 和 Decorator 实现？**

**6. 第三方服务集成策略**

*   **核心攻关问题 (MVP 1.0):**
    *   **支付网关 (Stripe 优先):** 完成核心支付流程（创建支付意图、处理回调）的后端集成和测试。
    *   **邮件服务 (SendGrid/Mailgun):** 完成基础邮件模板的集成和关键通知的发送测试。
    *   **地图服务 (用于药房查找):** 确定选型 (e.g., Mapbox, Google Maps API)，完成地理编码和附近搜索的后端逻辑封装。

**7. 开发流程与规范**

*   **核心攻关问题 (MVP 1.0):**
    *   **建立并执行代码审查 (Code Review) 流程。**
    *   **搭建基础的 CI/CD 流水线 (GitHub Actions):** 至少包含 Linting, Unit Tests, Build。
    *   **单元测试覆盖率目标 (核心模块 > 70%) 的达成策略。**
    *   **API 文档 (Swagger/OpenAPI) 的自动生成与维护机制。**

**8. Phase 0-1 详细工作计划与产出 (基于架构师调整后的规划)**

*   **Phase 0: 技术决策与准备 (2 周) - *正在进行/即将完成***
    *   **产出:** 本 SOP 0.5 文档，技术栈最终决策 (NestJS + Prisma + Supabase)，详细系统架构图 v1.0，Supabase 环境规划，CI/CD 初步方案。
*   **Phase 1: 核心基础设施与服务搭建 (4 周)**
    *   **Week 1-2: 基础架构与认证**
        *   **任务:** 数据库 Schema (Prisma) 实现与验证，核心认证服务 API (NestJS) 开发与测试，基础 API 框架搭建 (错误处理、日志、配置)，开发环境和基础 CI 配置。
        *   **核心攻关:** Prisma Schema 设计与迁移实践，NestJS 认证模块与 Supabase Auth 对接。
    *   **Week 3-4: 核心业务逻辑 API (订单、药品、支付基础)**
        *   **任务:** 处方/订单服务核心 API (创建、状态流转基础)，药品服务 API (搜索)，支付服务基础框架与支付意图创建 API，外部服务集成抽象层设计。
        *   **核心攻关:** 订单状态机实现，支付流程与数据一致性初步方案，Prisma 事务应用。
    *   **产出 (整个 Phase 1):** 可独立测试的核心服务 API (OpenAPI 规范 v1.0)，数据库 Schema v1.0 (Migrations)，Backend 项目骨架，CI/CD 可运行。

**9. 风险识别与应对**

*   **核心攻关问题 (MVP 1.0):**
    *   **Supabase 性能与限制验证:** 在 Phase 1 期间，针对核心查询和并发场景进行初步基准测试。
    *   **医疗数据合规性设计的早期介入:** 虽然 Phase 3 专项处理，但在数据库和 API 设计时，必须预先考虑敏感数据标识、加密需求和审计日志字段。
    *   **团队对 NestJS/Prisma 的熟练度提升:** Phase 0 和 Phase 1 初期安排学习和小型 PoC。

**10. 部署架构 (参考 `MVP 1.0 部署架构设计.md`)**

*   **核心攻关问题 (MVP 1.0):**
    *   **确定 MVP 1.0 的 Staging 和 Production 环境在 Render.com (或选定PaaS) 上的具体配置方案。**
    *   **完成 Backend 应用的 Dockerfile 优化和镜像构建流程。**
    *   **初步搭建 CI/CD 流程，实现自动化部署到 Staging 环境。**

---

**总结：**

这份 SOP 0.5 整合了多方反馈，特别是架构师的深度评审意见，旨在提供一个更具体、更聚焦、风险更可控的后端开发执行蓝图。它明确了技术选型，优化了服务架构，采纳了关键的设计文档，并为每个核心组件和阶段指出了 MVP 1.0 需要攻克的核心问题。

**下一步行动 (下次核心小组会议前，各角色准备工作 - 基于架构师邮件调整)：**

*   **后端 Leader (我):**
    *   [ ] 基于 `MVP 1.0 核心数据库表结构设计.md`，完成 **Prisma Schema 初稿**。
    *   [ ] 基于 `MVP 1.0 API设计规范和核心端点.md` 和本次 SOP 0.5 的服务模块，起草**核心 API (认证、处方/订单创建与查询、药品搜索) 的 OpenAPI 规范草案 (YAML/JSON)**。
    *   [ ] 搭建 **NestJS + Prisma 项目基础骨架**，并配置好基础模块（Config, Logging, Global Exception Filter, JWT Auth Guard）。
    *   [ ] 准备一份关于 **Prisma vs TypeORM 的简要评估对比表**，供团队最终决策（尽管架构师已推荐 Prisma）。
    *   [ ] 初步思考**支付流程中（诊所预付/信用额度模式）的事务一致性技术方案**。

*   **产品/市场经理:**
    *   [ ] **细化 MVP 1.0 功能的验收标准 (Acceptance Criteria)**，特别是针对核心业务流程的每个步骤。
    *   [ ] 提供**核心用户流程（医生开方、药房履约、管理员审核）的详细业务规则定义**，包括各种边界条件和异常情况的处理逻辑。
    *   [ ] 确认**医生推荐机制的具体规则和奖励方式**的初稿。

*   **前端 Leader:**
    *   [ ] 针对后端即将提供的 OpenAPI 规范草案，**准备前端适配需求清单和数据格式偏好**。
    *   [ ] 规划**前后端联调的时间节点和期望的 Mock API 支持方式**。
    *   [ ] 评估 **UI/UX 设计与后端数据模型（基于 Prisma Schema 初稿）的匹配度**，提前发现潜在的不一致。

*   **总监架构师:**
    *   [ ] 准备在下次会议上对技术选型（特别是 ORM）、服务架构、数据库设计、API 规范、Phase 1 详细计划进行**最终决策和批准**。
    *   [ ] 准备提供关于**事务管理、文件上传安全、第三方集成错误处理**等关键技术方案的深入指导。

我们的目标是在下一次核心小组会议上，能够基于这些准备工作，**最终敲定 SOP 1.0，并正式启动 Phase 1 的详细设计与开发工作。**