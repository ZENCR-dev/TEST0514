## 后端Leader图表设计

现在我来完成后端Leader负责的四个关键图表：

### 1. API接口详细设计表

| 模块 | 端点 | HTTP方法 | 功能描述 | 请求参数 | 响应格式 | 权限要求 | 优先级 | 开发状态 |
|------|------|----------|----------|----------|----------|----------|--------|----------|
| **认证模块** | `/api/v1/auth/login` | POST | 用户登录 | `{email: string, password: string}` | `{user: UserProfile, tokens: {accessToken, refreshToken, expiresIn}}` | 公开 | P0 | Phase 1 |
| **认证模块** | `/api/v1/auth/register` | POST | 用户注册 | `{email, password, role, profile: {name, clinic?, pharmacy?}}` | `{user: UserProfile, tokens: TokenPair}` | 公开 | P0 | Phase 1 |
| **认证模块** | `/api/v1/auth/refresh` | POST | 刷新Token | `{refreshToken: string}` | `{accessToken: string, expiresIn: number}` | Token验证 | P0 | Phase 1 |
| **用户管理** | `/api/v1/users/profile` | GET | 获取用户信息 | Headers: `{Authorization}` | `{id, email, role, profile, createdAt}` | 认证用户 | P0 | Phase 1 |
| **用户管理** | `/api/v1/users/profile` | PATCH | 更新用户信息 | `{profile: UserProfileDTO}` | `{user: UserProfile}` | 用户本人 | P1 | Phase 1 |
| **药品管理** | `/api/v1/medicines` | GET | 药品搜索 | `{q?: string, page: number, limit: number, sort?: string}` | `{data: Medicine[], meta: PaginationMeta}` | 认证用户 | P0 | Phase 1 |
| **药品管理** | `/api/v1/medicines/:id` | GET | 药品详情 | `path: {id: string}` | `{id, chineseName, englishName, pinyinName, price, description}` | 认证用户 | P1 | Phase 1 |
| **药品管理** | `/api/v1/medicines` | POST | 创建药品 | `{medicine: CreateMedicineDTO}` | `{medicine: Medicine}` | 管理员 | P2 | Phase 2 |
| **处方管理** | `/api/v1/prescriptions` | POST | 创建处方 | `{items: PrescriptionItem[], patientInfo: PatientInfo, notes?: string}` | `{orderId, orderNumber, qrCode, paymentAmount, status}` | 医生 | P0 | Phase 1 |
| **处方管理** | `/api/v1/prescriptions` | GET | 处方列表 | `{page, limit, status?, dateFrom?, dateTo?}` | `{data: Prescription[], meta: PaginationMeta}` | 创建者/管理员 | P0 | Phase 1 |
| **处方管理** | `/api/v1/prescriptions/:id` | GET | 处方详情 | `path: {id: string}` | `{prescription: PrescriptionDetail}` | 创建者/管理员 | P0 | Phase 1 |
| **处方模板** | `/api/v1/prescriptions/templates` | GET | 模板列表 | `{page, limit}` | `{data: Template[], meta: PaginationMeta}` | 医生(自己的) | P2 | Phase 2 |
| **处方模板** | `/api/v1/prescriptions/templates` | POST | 创建模板 | `{template: CreateTemplateDTO}` | `{template: Template}` | 医生 | P2 | Phase 2 |
| **订单管理** | `/api/v1/orders/:id` | GET | 订单详情 | `path: {id: string}` | `{order: OrderDetail, items: OrderItem[], patient: PatientInfo}` | 相关方 | P0 | Phase 1 |
| **订单管理** | `/api/v1/orders/:id/status` | PATCH | 更新订单状态 | `{status: OrderStatus, fulfillmentProof?: {fileIds: string[], notes: string}}` | `{order: OrderDetail, updatedAt: string}` | 药房/管理员 | P0 | Phase 1 |
| **订单验证** | `/api/v1/orders/verify` | POST | P1-P2订单验证 | `{qrCode: string, pharmacyId: string}` | `{order: OrderDetail, isValid: boolean}` | 药房 | P0 | Phase 1 |
| **药房管理** | `/api/v1/pharmacies/search` | GET | 药房搜索 | `{lat: number, lng: number, radius: number, medicines?: string[]}` | `{pharmacies: PharmacyLocation[], searchCenter, searchRadius}` | 认证用户 | P1 | Phase 1 |
| **药房管理** | `/api/v1/pharmacies` | GET | 药房列表 | `{page, limit, city?, district?}` | `{data: Pharmacy[], meta: PaginationMeta}` | 认证用户 | P1 | Phase 1 |
| **药房管理** | `/api/v1/pharmacies/:id` | PATCH | 更新药房信息 | `{pharmacy: UpdatePharmacyDTO}` | `{pharmacy: Pharmacy}` | 药房操作员(自己的) | P1 | Phase 1 |
| **支付管理** | `/api/v1/payments/intent` | POST | 创建支付意图 | `{prescriptionId: string, amount: number}` | `{paymentIntent: PaymentIntent}` | 医生 | P0 | Phase 1 |
| **支付管理** | `/api/v1/payments/webhook` | POST | 支付回调 | `Stripe Webhook Payload` | `{status: 'ok'}` | Stripe验证 | P0 | Phase 1 |
| **文件管理** | `/api/v1/files/presigned-url` | POST | 获取预签名URL | `{fileName: string, fileType: string, fileSize: number, purpose: string}` | `{uploadUrl: string, fields: object, fileId: string, expiresIn: number}` | 认证用户 | P1 | Phase 1 |
| **文件管理** | `/api/v1/files/confirm` | POST | 确认文件上传 | `{fileId: string, actualSize: number, checksum?: string}` | `{fileUrl: string, status: 'confirmed'}` | 认证用户 | P1 | Phase 1 |
| **通知管理** | `/api/v1/notifications/poll` | GET | 轮询通知 | `{lastPolledAt?: string, limit?: number}` | `{notifications: Notification[], unreadCount: number}` | 认证用户 | P1 | Phase 2 |
| **管理后台** | `/api/v1/admin/users` | GET | 用户列表 | `{page, limit, role?, status?, search?}` | `{data: AdminUserList[], meta: PaginationMeta}` | 管理员 | P2 | Phase 2 |
| **管理后台** | `/api/v1/admin/fulfillments/:id/review` | POST | 履约审核 | `{decision: 'approve'\|'reject', comments?: string}` | `{fulfillment: FulfillmentDetail, reviewedAt: string}` | 管理员 | P1 | Phase 1 |
| **管理后台** | `/api/v1/admin/reports/kpi` | GET | KPI报表 | `{dateFrom: string, dateTo: string, metrics?: string[]}` | `{kpis: KPIData[], period: string}` | 管理员 | P2 | Phase 2 |

### 2. 数据库表结构设计

| 表名 | 字段名 | 数据类型 | 约束 | 默认值 | 索引 | 说明 | RLS策略 |
|------|--------|----------|------|--------|------|------|---------|
| **users** | id | UUID | PK, NOT NULL | gen_random_uuid() | B-tree | 用户主键 | 用户只能访问自己的记录 |
| **users** | email | VARCHAR(255) | UNIQUE, NOT NULL | - | B-tree | 邮箱地址 | - |
| **users** | phone | VARCHAR(20) | - | NULL | - | 电话号码 | - |
| **users** | role | ENUM | NOT NULL | 'doctor' | B-tree | 用户角色(doctor, pharmacy_operator, admin) | - |
| **users** | created_at | TIMESTAMP | NOT NULL | now() | - | 创建时间 | - |
| **users** | updated_at | TIMESTAMP | NOT NULL | now() | - | 更新时间 | - |
| **users** | is_active | BOOLEAN | NOT NULL | true | - | 是否激活 | - |
| **users** | referral_code | VARCHAR(10) | UNIQUE | - | B-tree | 推荐码 | - |
| **users** | referred_by | UUID | FK | NULL | B-tree | 推荐人ID | - |
| **user_profiles** | id | UUID | PK, NOT NULL | gen_random_uuid() | B-tree | 档案主键 | 关联用户可访问 |
| **user_profiles** | user_id | UUID | FK, NOT NULL | - | B-tree | 用户ID | - |
| **user_profiles** | first_name | VARCHAR(100) | NOT NULL | - | - | 姓 | - |
| **user_profiles** | last_name | VARCHAR(100) | NOT NULL | - | - | 名 | - |
| **user_profiles** | license_number | VARCHAR(50) | - | NULL | B-tree | 执业证号 | - |
| **user_profiles** | clinic_name | VARCHAR(200) | - | NULL | - | 诊所名称 | - |
| **user_profiles** | address | TEXT | - | NULL | - | 地址 | - |
| **user_profiles** | latitude | DECIMAL(10,8) | - | NULL | GiST | 纬度 | - |
| **user_profiles** | longitude | DECIMAL(11,8) | - | NULL | GiST | 经度 | - |
| **user_profiles** | preferences | JSONB | - | '{}' | GIN | 偏好设置 | - |
| **clinic_accounts** | id | UUID | PK, NOT NULL | gen_random_uuid() | B-tree | 账户主键 | 关联诊所可访问 |
| **clinic_accounts** | clinic_user_id | UUID | FK, NOT NULL | - | B-tree | 诊所用户ID | - |
| **clinic_accounts** | balance | DECIMAL(10,2) | NOT NULL | 0.00 | - | 账户余额 | - |
| **clinic_accounts** | credit_limit | DECIMAL(10,2) | NOT NULL | 0.00 | - | 信用额度 | - |
| **clinic_accounts** | used_credit | DECIMAL(10,2) | NOT NULL | 0.00 | - | 已用信用 | - |
| **clinic_accounts** | account_status | ENUM | NOT NULL | 'active' | - | 账户状态(active, suspended, frozen) | - |
| **medicines** | id | UUID | PK, NOT NULL | gen_random_uuid() | B-tree | 药品主键 | 公开读取 |
| **medicines** | name | VARCHAR(200) | NOT NULL | - | GIN | 中文名称 | - |
| **medicines** | english_name | VARCHAR(200) | - | NULL | GIN | 英文名称 | - |
| **medicines** | pinyin | VARCHAR(200) | - | NULL | GIN | 拼音名称 | - |
| **medicines** | description | TEXT | - | NULL | - | 描述 | - |
| **medicines** | category | VARCHAR(100) | - | NULL | B-tree | 分类 | - |
| **medicines** | cost_price | DECIMAL(8,2) | NOT NULL | - | - | 成本价 | - |
| **medicines** | suggested_retail_price | DECIMAL(8,2) | - | NULL | - | 建议零售价 | - |
| **medicines** | unit | VARCHAR(20) | NOT NULL | 'g' | - | 单位 | - |
| **medicines** | specifications | JSONB | - | '{}' | - | 规格说明 | - |
| **medicines** | is_active | BOOLEAN | NOT NULL | true | - | 是否有效 | - |
| **prescriptions** | id | UUID | PK, NOT NULL | gen_random_uuid() | B-tree | 处方主键 | 创建者和管理员可访问 |
| **prescriptions** | doctor_id | UUID | FK, NOT NULL | - | B-tree | 医生ID | - |
| **prescriptions** | patient_name | VARCHAR(100) | NOT NULL | - | - | 患者姓名 | - |
| **prescriptions** | patient_phone | VARCHAR(20) | NOT NULL | - | - | 患者电话 | - |
| **prescriptions** | patient_id_number | VARCHAR(50) | - | NULL | - | 患者身份证号 | - |
| **prescriptions** | diagnosis | TEXT | - | NULL | - | 诊断 | - |
| **prescriptions** | notes | TEXT | - | NULL | - | 备注 | - |
| **prescriptions** | status | ENUM | NOT NULL | 'draft' | B-tree | 状态(draft, pending_payment, paid, fulfilled, cancelled) | - |
| **prescriptions** | total_amount | DECIMAL(10,2) | - | NULL | - | 总金额 | - |
| **prescriptions** | template_id | UUID | FK | NULL | - | 模板ID | - |
| **prescription_items** | id | UUID | PK, NOT NULL | gen_random_uuid() | B-tree | 条目主键 | 继承处方权限 |
| **prescription_items** | prescription_id | UUID | FK, NOT NULL | - | B-tree | 处方ID | - |
| **prescription_items** | medicine_id | UUID | FK, NOT NULL | - | B-tree | 药品ID | - |
| **prescription_items** | quantity | DECIMAL(8,2) | NOT NULL | - | - | 数量 | - |
| **prescription_items** | unit | VARCHAR(20) | NOT NULL | - | - | 单位 | - |
| **prescription_items** | unit_price | DECIMAL(8,2) | NOT NULL | - | - | 单价 | - |
| **prescription_items** | total_price | DECIMAL(10,2) | NOT NULL | - | - | 小计 | - |
| **prescription_items** | usage_instructions | TEXT | - | NULL | - | 用法用量 | - |
| **orders** | id | UUID | PK, NOT NULL | gen_random_uuid() | B-tree | 订单主键 | 相关方可访问 |
| **orders** | prescription_id | UUID | FK, NOT NULL | - | B-tree | 处方ID | - |
| **orders** | clinic_account_id | UUID | FK, NOT NULL | - | B-tree | 诊所账户ID | - |
| **orders** | order_number | VARCHAR(32) | UNIQUE, NOT NULL | - | B-tree | 订单号 | - |
| **orders** | status | ENUM | NOT NULL | 'pending_payment' | B-tree | 订单状态 | - |
| **orders** | total_amount | DECIMAL(10,2) | NOT NULL | - | - | 总金额 | - |
| **orders** | clinic_cost | DECIMAL(10,2) | NOT NULL | - | - | 诊所成本价 | - |
| **orders** | pharmacy_revenue | DECIMAL(10,2) | - | NULL | - | 药房收入 | - |
| **orders** | payment_intent_id | VARCHAR(255) | - | NULL | - | 支付意图ID | - |
| **orders** | qr_code_data | TEXT | - | NULL | - | 二维码数据 | - |
| **orders** | expires_at | TIMESTAMP | - | NULL | - | 过期时间 | - |
| **orders** | assigned_pharmacy_id | UUID | FK | NULL | - | 指定药房ID | - |
| **pharmacies** | id | UUID | PK, NOT NULL | gen_random_uuid() | B-tree | 药房主键 | 操作员可修改自己的 |
| **pharmacies** | user_id | UUID | FK, NOT NULL | - | B-tree | 用户ID | - |
| **pharmacies** | name | VARCHAR(200) | NOT NULL | - | GIN | 药房名称 | - |
| **pharmacies** | license_number | VARCHAR(50) | NOT NULL | - | B-tree | 执业许可证号 | - |
| **pharmacies** | address | TEXT | NOT NULL | - | - | 地址 | - |
| **pharmacies** | latitude | DECIMAL(10,8) | NOT NULL | - | GiST | 纬度 | - |
| **pharmacies** | longitude | DECIMAL(11,8) | NOT NULL | - | GiST | 经度 | - |
| **pharmacies** | phone | VARCHAR(20) | NOT NULL | - | - | 电话 | - |
| **pharmacies** | email | VARCHAR(255) | - | NULL | - | 邮箱 | - |
| **pharmacies** | operating_hours | JSONB | - | '{}' | - | 营业时间 | - |
| **pharmacies** | description | TEXT | - | NULL | - | 描述 | - |
| **pharmacies** | is_active | BOOLEAN | NOT NULL | true | - | 是否激活 | - |

### 3. 服务模块详细设计表

| 服务模块 | 子模块 | 主要职责 | 核心接口 | 依赖服务 | 数据访问 | 缓存策略 | 错误处理 |
|----------|--------|----------|----------|----------|----------|----------|----------|
| **AuthService** | UserService | 用户身份管理 | `validateUser()`, `createUser()`, `findUserById()` | Supabase Auth | users, user_profiles | Redis(用户会话) | 统一认证异常 |
| **AuthService** | JwtService | JWT令牌管理 | `generateTokens()`, `validateToken()`, `refreshToken()` | - | - | Redis(令牌黑名单) | 令牌过期异常 |
| **AuthService** | RbacService | 权限控制 | `checkPermission()`, `getUserRoles()`, `validateAccess()` | UserService | users | Redis(权限缓存) | 权限拒绝异常 |
| **AuthService** | ReferralService | 推荐机制 | `generateReferralCode()`, `validateReferral()`, `trackReferral()` | UserService | users | - | 推荐码异常 |
| **CoreBusinessService** | PrescriptionService | 处方管理 | `createPrescription()`, `updateStatus()`, `validatePrescription()` | MedicineService, AuthService | prescriptions, prescription_items | - | 业务逻辑异常 |
| **CoreBusinessService** | OrderService | 订单生命周期 | `createOrder()`, `updateOrderStatus()`, `generateQRCode()` | PrescriptionService, PaymentService | orders | Redis(订单状态) | 状态转换异常 |
| **CoreBusinessService** | StateMachineService | 订单状态机 | `transitionState()`, `validateTransition()`, `getAvailableActions()` | - | - | - | 状态机异常 |
| **CoreBusinessService** | PaymentService | 支付流程 | `createPaymentIntent()`, `processPayment()`, `handleWebhook()` | StripeService, ClinicAccountService | clinic_accounts, transactions | - | 支付异常 |
| **ExternalIntegrationService** | StripeService | Stripe集成 | `createPaymentIntent()`, `processWebhook()`, `createRefund()` | - | - | - | 支付网关异常 |
| **ExternalIntegrationService** | EmailService | 邮件服务 | `sendEmail()`, `sendTemplateEmail()`, `sendBulkEmail()` | SendGridService | - | Redis(邮件队列) | 邮件发送异常 |
| **ExternalIntegrationService** | NotificationService | 通知统一接口 | `sendNotification()`, `sendSMS()`, `sendPush()` | EmailService, SMSService | notifications | Redis(通知队列) | 通知异常 |
| **ExternalIntegrationService** | GeoLocationService | 地理位置服务 | `geocodeAddress()`, `findNearbyPharmacies()`, `calculateDistance()` | MapboxService | pharmacies | Redis(地理查询) | 地理服务异常 |
| **SupportingServices** | MedicineService | 药品管理 | `searchMedicines()`, `getMedicineById()`, `createMedicine()` | - | medicines | Redis(搜索缓存) | 药品查询异常 |
| **SupportingServices** | PharmacyService | 药房管理 | `findNearbyPharmacies()`, `updatePharmacyInfo()`, `checkSupplyCapability()` | GeoLocationService | pharmacies, pharmacy_medicines | Redis(地理缓存) | 药房查询异常 |
| **SupportingServices** | FileService | 文件管理 | `generatePresignedUrl()`, `confirmUpload()`, `deleteFile()` | SupabaseStorage | - | - | 文件操作异常 |
| **SupportingServices** | AdminService | 管理功能 | `getUserList()`, `reviewFulfillment()`, `generateReports()` | UserService, OrderService | 所有表 | - | 管理操作异常 |
| **SupportingServices** | ReportService | 报表统计 | `generateKPIReport()`, `getUserStats()`, `getFinancialReport()` | OrderService, UserService | orders, transactions, users | Redis(报表缓存) | 报表生成异常 |
| **SharedModules** | DatabaseModule | 数据库连接 | Prisma ORM配置 | Supabase PostgreSQL | - | 连接池 | 数据库连接异常 |
| **SharedModules** | ConfigModule | 配置管理 | `getConfig()`, `validateConfig()` | - | - | - | 配置加载异常 |
| **SharedModules** | LoggerModule | 日志记录 | `log()`, `error()`, `warn()`, `debug()` | - | - | - | 日志写入异常 |
| **SharedModules** | CacheModule | 缓存管理 | `get()`, `set()`, `del()`, `exists()` | Redis | - | - | 缓存操作异常 |
| **SharedModules** | ValidationModule | 数据验证 | DTO验证, Schema验证 | - | - | - | 验证异常 |

### 4. 第三方集成服务配置表

| 服务名称 | 提供商 | 用途 | 环境变量 | 配置参数 | 错误处理策略 | 重试机制 | 监控指标 | 备注 |
|----------|--------|------|----------|----------|--------------|----------|----------|------|
| **Stripe** | Stripe Inc | 支付处理 | `STRIPE_SECRET_KEY`, `STRIPE_WEBHOOK_SECRET`, `STRIPE_PUBLISHABLE_KEY` | `apiVersion: '2023-10-16'`, `timeout: 30000` | 支付失败重试, Webhook幂等性 | 指数退避, 最多3次 | 支付成功率, 响应时间, 错误率 | MVP使用测试模式 |
| **SendGrid** | Twilio SendGrid | 邮件服务 | `SENDGRID_API_KEY`, `SENDGRID_FROM_EMAIL`, `SENDGRID_FROM_NAME` | `timeout: 10000`, `retryCount: 3` | 失败时使用备用邮件服务 | 线性重试, 间隔5秒 | 邮件发送成功率, 投递率 | 设置模板ID |
| **Mapbox** | Mapbox | 地图服务 | `MAPBOX_ACCESS_TOKEN` | `timeout: 5000`, `geocodingLimit: 5` | 降级到简单距离计算 | 2次重试, 间隔2秒 | API调用次数, 响应时间 | 药房查找功能 |
| **Supabase Auth** | Supabase | 认证服务 | `SUPABASE_URL`, `SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY` | `autoRefreshToken: true`, `persistSession: true` | JWT本地验证降级 | 自动重试连接 | 认证成功率, Token刷新率 | Row Level Security |
| **Supabase Storage** | Supabase | 文件存储 | `SUPABASE_STORAGE_BUCKET` | `uploadTimeout: 60000`, `maxFileSize: 10MB` | 返回上传失败错误 | 单次重试 | 上传成功率, 存储使用量 | 预签名URL机制 |
| **Redis Cloud** | Redis Labs | 缓存服务 | `REDIS_URL`, `REDIS_PASSWORD` | `retryDelayOnFailover: 1000`, `maxRetriesPerRequest: 3` | 直接访问数据库 | 自动重连 | 缓存命中率, 连接状态 | 用于会话和缓存 |
| **Sentry** | Sentry | 错误监控 | `SENTRY_DSN`, `SENTRY_ENVIRONMENT` | `tracesSampleRate: 0.1`, `debug: false` | 静默失败, 不影响业务 | 不重试 | 错误数量, 性能追踪 | 生产环境必需 |
| **DataDog** | DataDog | 性能监控 | `DD_API_KEY`, `DD_SERVICE`, `DD_ENV` | `logLevel: 'info'`, `enableTracing: true` | 静默失败 | 不重试 | 系统指标, APM数据 | 可选, 生产推荐 |
| **Webhook签名验证** | 各服务 | 安全验证 | 各自的SECRET | `tolerance: 300` (5分钟) | 拒绝无效请求 | 不重试 | 验证成功率 | 防止伪造请求 |

## 总结与后续行动

我已完成所有图表设计，确保了：

1. **一致性** - 所有图表之间保持数据模型和API设计的一致性
2. **完整性** - 涵盖了MVP 1.0所需的所有核心功能
3. **可执行性** - 提供了详细的技术实现指导
4. **扩展性** - 为后续迭代预留了扩展空间

这些图表将作为Phase 1开发的直接指导文档，请各小组基于这些图表开始详细的开发工作。