### **新西兰中医处方平台 - 前后端联调指导文档 v1.9 (紧急修订版)**

**文档版本：** v1.9
**最后更新：** 2025年6月19日 18:30 NZST
**负责人：** 核心小组
**状态：** 🚨 **紧急修订 - 基于技术选型最终决策的关键更新**

---

#### **紧急修订说明**

本 v1.9 版本是基于核心小组在技术可行性评审中的**最终技术决策**而进行的紧急修订。主要变更包括：

1. **API 契约测试技术选型最终确定**：正式放弃 PactumJS，采纳 Jest + Supertest 方案
2. **实施时间线紧急调整**：契约测试交付截止时间调整为**今晚 21:00 NZST**
3. **团队职责重新分配**：明确后端团队全权负责契约测试脚本开发与交付

**本版本为最终执行版本，任何技术选型不可再更改。**

---

#### **1. 联调启动背景与最终目标**

**1.1 当前状态总结 (信息对齐)**

*   **后端团队：** 已完成为期三天的"修复与适配冲刺"。所有 P0 级环境问题（数据库连接、端口占用）已解决。核心认证功能（包括 `refreshToken` 机制）已 100% 实现并通过 187 个测试用例。API 适配层已开发完成，Staging 环境部署的 API **在数据结构和格式上已与前端期望完全一致**。
*   **前端团队：** 已完成为期三天的"联调准备冲刺"。企业级的 `apiClient.ts`（含 Token 自动刷新和统一错误处理）已开发完成。API 类型系统已完成重构，100% 匹配后端规范。**前端已完全具备对接真实 API 的能力。**
*   **技术选型最终确定：** 经过可行性评审，正式确定使用 **Jest + Supertest** 进行 API 契约测试，放弃原计划的 PactumJS 方案。
*   **结论：** 经过双方的卓越努力和技术决策优化，所有已知的技术障碍和信息偏差均已消除。**项目已具备启动第一阶段联调的全部条件。**

**1.2 总体目标**
在 **3 天内**，高效、高质量地完成**认证模块**和**药品模块**的前后端端到端联调，验证核心用户流程的可用性、稳定性和性能，为后续更复杂的业务流程联调奠定坚实基础。

**1.3 联调范围 (第一阶段)**

| 模块 | 功能范围 | API端点 (参考) | 优先级 |
| :--- | :--- | :--- | :---: |
| **认证模块** | 登录、注册、用户信息获取、Token 刷新与权限验证 | `/api/v1/auth/*` | **P0** |
| **药品模块** | 药品列表获取、按关键词搜索、分页功能 | `/api/v1/medicines` | **P0** |

**1.4 最终成功标准**
*   ✅ **功能层面：** 所有核心用户流程（注册->登录->Token刷新->查看药品列表->搜索）可无阻塞地完整执行。
*   ✅ **数据层面：** 前后端数据交互 100% 兼容，无任何格式或类型不匹配问题。
*   ✅ **性能层面：** 所有联调 API 的 P95 响应时间 **< 500ms** (Staging 环境基准)。
*   ✅ **健壮性层面：** 所有已知的错误场景均有优雅的前端处理和用户提示，后端能正确响应。

---

#### **2. 团队职责分工 (基于最终技术决策的重新分配)**

*   **🔧 后端团队职责 (P0 级紧急任务):**
    *   **🚨 API 契约测试脚本开发与交付 (今晚 21:00 前必须完成):**
        *   [ ] **使用 Jest + Supertest 开发契约测试脚本**
        *   [ ] **创建 test/contract/ 目录结构**
        *   [ ] **开发响应格式静态验证测试** (test/contract/response-format.contract.spec.ts)
        *   [ ] **开发核心端点连通性测试** (test/contract/endpoints.contract.spec.ts)
        *   [ ] **提交 PR 并附上测试通过截图**
    *   **其他职责:**
        *   [ ] **提供并执行增强版自动化健康检查脚本**
        *   [ ] **提供数据质量验证脚本**
        *   [ ] **建立轻量级实时监控页面**

*   **🎨 前端团队职责:**
    *   **契约测试验证 (后端交付后立即执行):**
        *   [ ] **验证后端提交的契约测试脚本可正常运行**
        *   [ ] **在本地环境复现测试通过结果**
        *   [ ] **在 PR 或 Slack 提供验证反馈**
    *   **其他职责:**
        *   [ ] **配合增强的错误场景测试** (按照 4.2 节的优先级)
        *   [ ] **准备 Plan B 切换流程** (一键切换回 Mock API)

---

#### **3. API 契约测试最终实施方案 (Jest + Supertest)**

**3.1 技术选型最终决策**

- **✅ 正式采纳：** Jest + Supertest
  - **零学习成本**：团队已深度使用 Jest
  - **技术栈统一**：与现有测试框架完全一致
  - **能力足够**：满足 API 端点黑盒测试需求

- **❌ 正式放弃：** PactumJS
  - **学习曲线过陡**：在紧迫时间下不可行
  - **集成复杂度高**：引入新框架风险太大

**3.2 契约测试脚本开发计划 (90分钟)**

**阶段 1: 环境准备 (15分钟)**
```bash
# 后端团队执行
npm install --save-dev supertest @types/supertest
mkdir -p test/contract
touch test/contract/response-format.contract.spec.ts
touch test/contract/endpoints.contract.spec.ts
```

**阶段 2: 响应格式静态验证 (30分钟)**
- **文件：** `test/contract/response-format.contract.spec.ts`
- **逻辑：** 验证 `output/api-response-samples.json` 中的 5 个核心响应样本
- **重点验证：** 数据结构、字段名、数据类型是否符合前端期望
- **示例结构：**
```javascript
describe('API Response Format Contract Tests', () => {
  test('Login Success Response Format', () => {
    // 验证登录成功响应的数据结构
  });
  
  test('Medicines List Response Format', () => {
    // 验证药品列表响应的数据结构
  });
});
```

**阶段 3: 端点连通性测试 (30分钟)**
- **文件：** `test/contract/endpoints.contract.spec.ts`
- **逻辑：** 对 Staging 环境的 2 个核心端点发起真实请求
- **重点验证：**
  - HTTP 状态码为 200
  - 响应包含 `success: true`, `data`, `meta.timestamp` 等顶级键
  - **不验证具体业务数据内容**

**阶段 4: 交付与验证 (15分钟)**
- 后端提交 PR 并附上 `npm test test/contract/` 成功截图
- 前端拉取代码并本地验证

**3.3 验收标准**
- ✅ 所有契约测试 100% 通过
- ✅ 前端团队能够成功复现测试结果
- ✅ 今晚 21:00 前完成交付

---

#### **4. 联调工作流程与时间表 (基于契约测试完成后)**

**今晚 (Day 0): 契约测试交付日**
*   **19:00 - 21:00：** **🚨 P0 任务 - 后端团队开发并交付契约测试脚本**
*   **21:00 - 21:30：** 前端团队验证契约测试脚本
*   **21:30 - 22:00：** 最终联调准备状态确认

**Day 1 (明天): 环境确认与认证模块联调 (总计 8 小时)**

| 时间 (NZST) | 任务 | 负责人 | 产出/验收标准 |
| :--- | :--- | :--- | :--- |
| **08:30 - 09:00** | **Phase 0: 自动化环境健康检查** | **后端 (执行)**, 前端 (验证) | ✅ 后端运行增强版健康检查脚本，并将结果截图发到 Slack。前端确认 API 可访问。 |
| **09:00 - 09:45** | **Phase 1: API 契约测试执行** | **前端 (执行)**, 后端 (支持) | ✅ 前端运行契约测试脚本，**必须 100% 通过**。如有失败，**联调暂停**，后端在 1 小时内修复。 |
| **09:45 - 10:00** | **Buffer Time / 休息** | | |
| **10:00 - 12:30** | **Phase 2.1: 认证模块核心联调** | 前端 (主导), 后端 (支持) | ✅ TC-AUTH-01/02/03/04 通过。 |
| **12:30 - 13:15** | 午休 | | |
| **13:15 - 16:00** | **Phase 2.2: Token 刷新与并发测试** | 前端 (主导), 后端 (支持) | ✅ TC-AUTH-05/06/07 通过。**重点测试并发 Token 刷新。** |
| **16:00 - 16:45** | **Phase 2.3: P0 级错误场景测试** | 前端 & 后端 | ✅ 联合测试网络超时、401/403 错误处理。 |
| **16:45 - 17:00** | 当日总结准备 | | |
| **17:00 - 17:30** | **每日联调站会** | 核心小组 | 同步 Day 1 成果、问题和 Day 2 计划。 |

**Day 2 (后天): 药品模块联调与性能基准测试 (总计 8 小时)**

| 时间 (NZST) | 任务 | 负责人 | 产出/验收标准 |
| :--- | :--- | :--- | :--- |
| **09:00 - 12:00** | **Phase 3.1: 药品模块核心联调** | 前端 (主导), 后端 (支持) | ✅ TC-MED-01/02/03/04 通过。 |
| **12:00 - 12:45** | 午休 | | |
| **12:45 - 14:30** | **Phase 3.2: 药品模块增强与错误场景测试** | 前端 & 后端 | ✅ TC-MED-05/06 通过。✅ 联合测试 429 速率限制、5xx 服务器错误等。 |
| **14:30 - 16:30** | **Phase 3.3: 性能基准测试** | **后端 (主导)**, 前端 (观察) | ✅ 对认证和药品模块核心 API 进行 k6 压力测试，验证 P95 < 500ms 指标。 |
| **16:30 - 17:00** | 当日总结准备 | | |
| **17:00 - 17:30** | **每日联调站会** | 核心小组 | 同步 Day 2 成果、问题和 Day 3 计划。 |

**Day 3 (大后天): 综合测试、验收与总结 (总计 8 小时)**

| 时间 (NZST) | 任务 | 负责人 | 产出/验收标准 |
| :--- | :--- | :--- | :--- |
| **09:00 - 12:00** | **Phase 4.1: 综合与异常场景测试** | **前端 (主导)**, 后端 (支持) | ✅ **TC-INTEGRATION-01:** 登录后搜索药品的跨模块流程无缝衔接。✅ 测试网络中断、服务器 5xx 错误等场景，前端有优雅的降级和提示。 |
| **12:00 - 13:00** | 午休 & 上午问题复盘 | | |
| **13:00 - 15:00** | **Phase 4.2: 性能基准验证** | **后端 (主导)**, 前端 (观察) | ✅ 后端使用 k6 等工具对联调的 API 进行压力测试，验证 P95 < 500ms 指标达成。 |
| **15:00 - 16:30** | **Phase 4.3: 最终验收与问题清零** | 前端 & 后端 | 双方共同确认所有测试用例通过，所有 P0/P1 级问题已关闭。 |
| **16:30 - 17:30** | **第一阶段联调总结会** | 核心小组 | 回顾联调成果，总结经验教训，讨论并规划第二阶段联调（订单、支付流程）的启动时间。 |

---

#### **5. 联调测试用例 (最终增强版)**

*   **5.1 认证模块测试用例 (TC-AUTH):**
    *   **TC-AUTH-01:** 用户注册功能验证
    *   **TC-AUTH-02:** 用户登录功能验证  
    *   **TC-AUTH-03:** 获取用户信息功能验证
    *   **TC-AUTH-04:** Token 过期处理验证
    *   **TC-AUTH-05:** Token 自动刷新功能验证
    *   **TC-AUTH-06:** 权限验证功能测试
    *   **TC-AUTH-07 (新增):** 并发 Token 刷新竞态条件测试
    *   **TC-AUTH-08 (新增):** 异常 Token 处理测试 (超长、格式错误)

*   **5.2 药品模块测试用例 (TC-MED):**
    *   **TC-MED-01:** 药品列表获取功能验证
    *   **TC-MED-02:** 药品搜索功能验证
    *   **TC-MED-03:** 分页功能验证
    *   **TC-MED-04:** 排序功能验证
    *   **TC-MED-05 (新增):** 分页边界条件测试 (`page=0`, `limit>100` 等)
    *   **TC-MED-06 (新增):** 特殊字符与 emoji 搜索测试

*   **5.3 错误场景测试优先级:**
    *   **P0 (Day 1/2 必须测试):** 网络超时、Token 过期、400/401/403 错误。
    *   **P1 (Day 3 必须测试):** 429 Rate limiting, 5xx 服务器错误。
    *   **P2 (Day 3 酌情测试):** 异常 JSON 响应, 并发竞态条件。

---

#### **6. 问题处理与风险管控 (最终版)**

*   **6.1 问题升级机制 (细化):**
    *   **P0 问题处理流程：**
        *   **0-15分钟:** Slack 报告后，双方 Leader 确认并定位。
        *   **15-60分钟:** 提供临时解决方案或 workaround。
        *   **1-4小时:** 根本原因修复并部署到 Staging。
        *   **升级机制：** **若 2 小时内无明确解决方案，问题自动升级至总监架构师和产品经理。**

*   **6.2 风险与应急预案:**
    *   **环境不可用：**
        *   **应对:** 后端必须在 **1 小时内**恢复服务。若无法恢复，立即启动 **Plan B** (前端切换回 Mock API)。
    *   **API 契约测试失败：**
        *   **应对:** **联调暂停。** 后端必须在 **2 小时内**修复适配层并重新部署。

*   **6.3 应急预案与回滚机制:**
    *   **环境回滚：** 如果 Staging 环境在部署新版本后出现 P0 级问题且无法在 1 小时内修复，后端 DevOps 负责人将立即通过 Render.com 的"一键回滚"功能，将服务回滚到上一个稳定版本，并通知所有团队。
    *   **前端回滚：** 如果联调被迫暂停，前端团队应立即执行其 Plan B，将 apiClient.ts 的 API 基地址切换回 Mock Server，确保前端内部开发工作可以继续。

---

#### **7. 最终行动指令 (立即执行)**

**🚨 TO: 后端团队 (P0 级紧急任务)**

**立即、马上、现在就启动契约测试脚本开发！**

1. **19:00 前完成环境准备**
   - 安装 supertest 和相关依赖
   - 创建 test/contract/ 目录结构

2. **20:00 前完成核心测试脚本**
   - 开发响应格式静态验证测试
   - 开发端点连通性测试

3. **21:00 前完成交付**
   - 提交 PR 并附上测试通过截图
   - 在 Slack 发布交付确认

**TO: 前端团队**

1. **准备本地验证环境**
   - 确保能够运行项目的 npm test 命令
   - 准备好验证流程

2. **后端交付后立即验证**
   - 拉取最新代码
   - 运行契约测试并验证结果
   - 在 PR 或 Slack 提供反馈

---

#### **8. 附录**

**8.1 契约测试脚本模板**

```javascript
// test/contract/response-format.contract.spec.ts
describe('API Response Format Contract Tests', () => {
  const responseSamples = require('../../output/api-response-samples.json');
  
  test('Login Success Response Format', () => {
    const loginResponse = responseSamples.auth.loginSuccess;
    expect(loginResponse).toHaveProperty('success', true);
    expect(loginResponse).toHaveProperty('data');
    expect(loginResponse.data).toHaveProperty('accessToken');
    expect(loginResponse.data).toHaveProperty('refreshToken');
    expect(loginResponse.data).toHaveProperty('user');
    expect(loginResponse.data.user).toHaveProperty('id');
    expect(loginResponse.data.user).toHaveProperty('email');
    expect(loginResponse.data.user).toHaveProperty('role');
  });
  
  // 其他响应格式测试...
});
```

```javascript
// test/contract/endpoints.contract.spec.ts
const request = require('supertest');

describe('API Endpoints Contract Tests', () => {
  const API_BASE_URL = process.env.API_BASE_URL || 'https://staging-api.tcm.onrender.com';
  
  test('POST /api/v1/auth/login - Endpoint Connectivity', async () => {
    const response = await request(API_BASE_URL)
      .post('/api/v1/auth/login')
      .send({
        email: 'test@example.com',
        password: 'password123'
      })
      .timeout(10000);
    
    // 只验证连通性和基础结构，不验证具体业务逻辑
    expect([200, 400, 401]).toContain(response.status);
    expect(response.body).toHaveProperty('success');
    if (response.body.success) {
      expect(response.body).toHaveProperty('data');
    } else {
      expect(response.body).toHaveProperty('error');
    }
  });
  
  // 其他端点连通性测试...
});
```

**8.2 今晚检查清单**

```bash
# 后端团队执行
□ supertest 依赖已安装
□ test/contract/ 目录已创建
□ response-format.contract.spec.ts 已开发并测试通过
□ endpoints.contract.spec.ts 已开发并测试通过
□ PR 已提交并附上截图
□ Slack 交付确认已发布

# 前端团队执行  
□ 本地验证环境已准备就绪
□ 已成功拉取并运行契约测试
□ 验证结果已反馈
□ Plan B 切换流程已确认就绪
```

---

### **联调启动最终确认**

**契约测试脚本必须在今晚 21:00 (NZST) 前完成交付并通过前端验证。**

**联调将于明天上午 08:30 (NZST) 准时开始。**

- **08:30 - 09:00:** 后端执行最终版的健康检查和数据质量检查
- **09:00 - 09:45:** **前端运行契约测试，必须 100% 通过，否则联调暂停**

**这是最后的冲刺，让我们确保明天的联调能够顺利启动！**