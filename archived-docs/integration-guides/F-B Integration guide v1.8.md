### **新西兰中医处方平台 - 前后端联调指导文档 v1.8 (最终执行版)**

**文档版本：** v1.8
**最后更新：** 2025年6月19日
**负责人：** 核心小组
**状态：** ✅ **最终批准 - 所有团队必须严格遵循此版本**

---

#### **前言：基于最终架构评审的行动纲领**

本 v1.8 指南是在 v1.7 基础上，根据总监架构师在执行层面的最终评审意见修订而成。它解决了原计划中关于**环境验证、API 契约测试、性能测试时机、错误场景覆盖、数据质量保证和监控方案**等方面的具体技术实现缺陷，并就**监控、脚本健壮性、契约测试细节**等方面提出了几项关键的、必须在联调前解决的改进建议。

**本文件是第一阶段联调的唯一、最终行动指南。**

---

#### **1. 联调启动背景与最终目标**

**1.1 当前状态总结 (信息对齐)**

*   **后端团队：** 已完成为期三天的“修复与适配冲刺”。所有 P0 级环境问题（数据库连接、端口占用）已解决。核心认证功能（包括 `refreshToken` 机制）已 100% 实现并通过 187 个测试用例。API 适配层已开发完成，Staging 环境部署的 API **在数据结构和格式上已与前端期望完全一致**。
*   **前端团队：** 已完成为期三天的“联调准备冲刺”。企业级的 `apiClient.ts`（含 Token 自动刷新和统一错误处理）已开发完成。API 类型系统已完成重构，100% 匹配后端规范。**前端已完全具备对接真实 API 的能力。**
*   **结论：** 经过双方的卓越努力，所有已知的技术障碍和信息偏差均已消除。**项目已具备启动第一阶段联调的全部条件。**

**1.2 总体目标**
在 **3 天内**，高效、高质量地完成**认证模块**和**药品模块**的前后端端到端联调，验证核心用户流程的可用性、稳定性和性能，为后续更复杂的业务流程联调奠定坚实基础。

**1.3 联调范围 (第一阶段)**

| 模块 | 功能范围 | API端点 (参考) | 优先级 |
| :--- | :--- | :--- | :---: |
| **认证模块** | 登录、注册、用户信息获取、Token 刷新与权限验证 | `/api/v1/auth/*` | **P0** |
| **药品模块** | 药品列表获取、按关键词搜索、分页功能 | `/api/v1/medicines` | **P0** |

**1.4 最终成功标准**
*   ✅ **功能层面：** 所有核心用户流程（注册->登录->Token刷新->查看药品列表->搜索）可无阻塞地完整执行。
*   ✅ **数据层面：** 前后端数据交互 100% 兼容，无任何格式或类型不匹配问题。
*   ✅ **性能层面：** 所有联调 API 的 P95 响应时间 **< 500ms** (Staging 环境基准)。
*   ✅ **健壮性层面：** 所有已知的错误场景均有优雅的前端处理和用户提示，后端能正确响应。

---

#### **2. 团队职责分工 (职责强化与新增)**

*   **🎨 前端团队职责:**
    *   **新增职责：**
        *   [ ] **执行自动化 API 契约测试：** 在联调正式开始前（Day 1 上午），使用 PactumJS 或类似工具，运行由后端提供的契约测试脚本。
        *   **配合增强的错误场景测试：** 按照 **4.2 节** 的优先级，重点测试 P0 级别的错误场景。
*   **🔧 后端团队职责:**
    *   **新增职责：**
        *   [ ] **提供并执行增强版自动化健康检查脚本：** 在联调开始前，提供并执行包含超时设置、认证服务检查、数据库连接检查的增强版脚本。
        *   [ ] **提供 API 契约测试文件：** 提供一份可由前端直接运行的、基于 PactumJS 或 Jest 的 API 契约测试代码。
        *   [ ] **提供数据质量验证脚本：** 提供 `validation/data-quality-check.sql` 脚本，并执行验证，确保数据质量。
        *   **建立轻量级实时监控页面：** 提供一个简单的内部 Dashboard，用于实时查看核心监控指标。

---

#### **3. 联调工作流程与时间表 (最终优化版)**

**Day 0 (今日下午): 联调前置准备 (后端团队)**
*   **任务：**
    1.  完成并验证增强版健康检查脚本。
    2.  完成并验证 API 契约测试脚本。
    3.  完成并验证数据质量检查脚本。
    4.  搭建并部署轻量级监控 Dashboard。
*   **目标：** 确保明天联调开始时，所有验证工具和监控手段都已就绪。

**Day 1 (明天): 环境确认、契约验证与认证模块联调 (总计 8 小时)**

| 时间 (NZST) | 任务 | 负责人 | 产出/验收标准 |
| :--- | :--- | :--- | :--- |
| **08:30 - 09:00** | **Phase 0: 自动化环境健康检查** | **后端 (执行)**, 前端 (验证) | ✅ 后端运行增强版健康检查脚本，并将结果截图发到 Slack。前端确认 API 可访问。 |
| **09:00 - 09:45** | **Phase 1: API 契约测试** | **前端 (执行)**, 后端 (支持) | ✅ 前端运行契约测试脚本，**必须 100% 通过**。如有失败，**联调暂停**，后端在 1 小时内修复。 |
| **09:45 - 10:00** | **Buffer Time / 休息** | | |
| **10:00 - 12:30** | **Phase 2.1: 认证模块核心联调** | 前端 (主导), 后端 (支持) | ✅ TC-AUTH-01/02/03/04 通过。 |
| **12:30 - 13:15** | 午休 | | |
| **13:15 - 16:00** | **Phase 2.2: Token 刷新与并发测试** | 前端 (主导), 后端 (支持) | ✅ TC-AUTH-05/06/07 通过。**重点测试并发 Token 刷新。** |
| **16:00 - 16:45** | **Phase 2.3: P0 级错误场景测试** | 前端 & 后端 | ✅ 联合测试网络超时、401/403 错误处理。 |
| **16:45 - 17:00** | 当日总结准备 | | |
| **17:00 - 17:30** | **每日联调站会** | 核心小组 | 同步 Day 1 成果、问题和 Day 2 计划。 |

**Day 2 (后天): 药品模块联调与性能基准测试 (总计 8 小时)**

| 时间 (NZST) | 任务 | 负责人 | 产出/验收标准 |
| :--- | :--- | :--- | :--- |
| **09:00 - 12:00** | **Phase 3.1: 药品模块核心联调** | 前端 (主导), 后端 (支持) | ✅ TC-MED-01/02/03/04 通过。 |
| **12:00 - 12:45** | 午休 | | |
| **12:45 - 14:30** | **Phase 3.2: 药品模块增强与错误场景测试** | 前端 & 后端 | ✅ TC-MED-05/06 通过。✅ 联合测试 429 速率限制、5xx 服务器错误等。 |
| **14:30 - 16:30** | **Phase 3.3: 性能基准测试** | **后端 (主导)**, 前端 (观察) | ✅ 对认证和药品模块核心 API 进行 k6 压力测试，验证 P95 < 500ms 指标。 |
| **16:30 - 17:00** | 当日总结准备 | | |
| **17:00 - 17:30** | **每日联调站会** | 核心小组 | 同步 Day 2 成果、问题和 Day 3 计划。 |

**Day 3 (大后天): 综合测试、验收与总结 (总计 8 小时)**

| 时间 (NZST) | 任务 | 负责人 | 产出/验收标准 |
| :--- | :--- | :--- | :--- |
| **09:00 - 12:00** | **Phase 4.1: 综合与异常场景测试** | **前端 (主导)**, 后端 (支持) | ✅ **TC-INTEGRATION-01:** 登录后搜索药品的跨模块流程无缝衔接。✅ 测试网络中断、服务器 5xx 错误等场景，前端有优雅的降级和提示。 |
| **12:00 - 13:00** | 午休 & 上午问题复盘 | | |
| **13:00 - 15:00** | **Phase 4.2: 性能基准验证** | **后端 (主导)**, 前端 (观察) | ✅ 后端使用 k6 等工具对联调的 API 进行压力测试，验证 P95 < 500ms 指标达成。 |
| **15:00 - 16:30** | **Phase 4.3: 最终验收与问题清零** | 前端 & 后端 | 双方共同确认所有测试用例通过，所有 P0/P1 级问题已关闭。 |
| **16:30 - 17:30** | **第一阶段联调总结会** | 核心小组 | 回顾联调成果，总结经验教训，讨论并规划第二阶段联调（订单、支付流程）的启动时间。 |

---

#### **4. 联调测试用例 (最终增强版)**

*   **4.1 认证模块测试用例 (TC-AUTH):**
    *   (保留 TC-AUTH-01 至 06)
    *   **TC-AUTH-07 (新增): 并发 Token 刷新竞态条件测试**
    *   **TC-AUTH-08 (新增): 异常 Token 处理测试 (超长、格式错误)**
*   **4.2 药品模块测试用例 (TC-MED):**
    *   (保留 TC-MED-01 至 04)
    *   **TC-MED-05 (新增): 分页边界条件测试 (`page=0`, `limit>100` 等)**
    *   **TC-MED-06 (新增): 特殊字符与 emoji 搜索测试**
*   **4.3 错误场景测试优先级:**
    *   **P0 (Day 1/2 必须测试):** 网络超时、Token 过期、400/401/403 错误。
    *   **P1 (Day 3 必须测试):** 429 Rate limiting, 5xx 服务器错误。
    *   **P2 (Day 3 酌情测试):** 异常 JSON 响应, 并发竞态条件。

---

#### **5. 问题处理与风险管控 (最终版)**

*   **5.1 问题升级机制 (细化):**
    *   **P0 问题处理流程：**
        *   **0-15分钟:** Slack 报告后，双方 Leader 确认并定位。
        *   **15-60分钟:** 提供临时解决方案或 workaround。
        *   **1-4小时:** 根本原因修复并部署到 Staging。
        *   **升级机制：** **若 2 小时内无明确解决方案，问题自动升级至总监架构师和产品经理。**
*   **5.2 风险与应急预案:**
    *   **环境不可用：**
        *   **应对:** 后端必须在 **1 小时内**恢复服务。若无法恢复，立即启动 **Plan B** (前端切换回 Mock API)。
    *   **API 契约测试失败：**
        *   **应对:** **联调暂停。** 后端必须在 **2 小时内**修复适配层并重新部署。
* **5.3: 应急预案与回滚机制**
	- **环境回滚：** 如果 Staging 环境在部署新版本后出现 P0 级问题且无法在 1 小时内修复，后端 DevOps 负责人将立即通过 Render.com 的“一键回滚”功能，将服务回滚到上一个稳定版本，并通知所有团队。
    
	- **前端回滚：** 如果联调被迫暂停，前端团队应立即执行其 Plan B，将 apiClient.ts 的 API 基地址切换回 Mock Server，确保前端内部开发工作可以继续。
---

#### **6. 附录 (最终版)**

*   **附录 6.1：API 响应样本 (最终版)**

本样本数据严格遵循我们已确认的 API 设计规范，包括**扁平化的成功响应格式**、**统一的错误响应结构**、**小写的角色枚举值**以及**前端期望的字段名和数据类型**。

##### **认证模块 (Authentication)**

**`POST /api/v1/auth/login` - 用户登录**

**✅ 成功响应 (HTTP 200 OK)**
```json
{
  "success": true,
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJjZTQyYjQ4My0xZGRiLTQxYjItYjE3OS0wYjJkM2Q1YjY5MjEiLCJyb2xlIjoicHJhY3RpdGlvbmVyIiwiaWF0IjoxNzE4Nzg1MjAwLCJleHAiOjE3MTg3ODYxMDB9.abcdefg...",
    "refreshToken": "a1b2c3d4.eyJzdWIiOiJjZTQyYjQ4My0xZGRiLTQxYjItYjE3OS0wYjJkM2Q1YjY5MjEiLCJleHAiOjE3MTkzOTAwMDB9.hijklmn...",
    "user": {
      "id": "ce42b483-1ddb-41b2-b179-0b2d3d5b6921",
      "email": "doctor.test@tcm.com",
      "name": "John Doe",
      "role": "doctor" 
    }
  },
  "meta": {
    "timestamp": "2025-06-19T10:00:00.000Z"
  }
}
```

**`POST /api/v1/auth/register` - 用户注册**

**❌ 错误响应 - 邮箱已存在 (HTTP 409 Conflict)**
```json
{
  "success": false,
  "error": {
    "code": "USER_001",
    "message": "A user with this email already exists.",
    "details": {
      "field": "email",
      "value": "doctor.test@tcm.com"
    },
    "timestamp": "2025-06-19T10:06:30.456Z"
  }
}
```

**`GET /api/v1/auth/me` - 获取当前用户信息**

**✅ 成功响应 (HTTP 200 OK)**
```json
{
  "success": true,
  "data": {
    "id": "ce42b483-1ddb-41b2-b179-0b2d3d5b6921",
    "email": "doctor.test@tcm.com",
    "name": "John Doe",
    "role": "doctor",
    "profile": {
        "licenseNumber": "NZTCM-12345",
        "clinicName": "Auckland Acupuncture Clinic"
    }
  },
  "meta": {
    "timestamp": "2025-06-19T10:10:00.000Z"
  }
}
```

---

##### **药品模块 (Medicines)**

**`GET /api/v1/medicines` - 药品搜索/列表**

**✅ 成功响应 - 带分页 (HTTP 200 OK)**
```json
{
  "success": true,
  "data": {
    "data": [
      {
        "id": "d1e2f3a4-b5c6-d7e8-f9a0-b1c2d3e4f5a6",
        "sku": "DG-001",
        "name": "当归",
        "pinyin": "Dang Gui",
        "category": "补血药",
        "pricePerGram": 0.12
      },
      {
        "id": "g7h8i9j0-k1l2-m3n4-o5p6-q7r8s9t0u1v2",
        "sku": "RS-001",
        "name": "人参",
        "pinyin": "Ren Shen",
        "category": "补气药",
        "pricePerGram": 0.85
      }
    ],
    "meta": {
      "pagination": {
        "page": 1,
        "limit": 2,
        "totalItems": 442,
        "totalPages": 221,
        "hasNextPage": true,
        "hasPrevPage": false
      }
    }
  },
  "meta": {
    "timestamp": "2025-06-19T10:15:00.000Z"
  }
}
```

---

##### **附录 6.2：问题报告模板**

为了高效地定位和解决问题，请所有团队成员在 Slack `#frontend-backend-integration` 频道中严格使用以下模板提交问题。

```markdown
---
**问题报告**

**问题级别：** P0 (阻塞性) / P1 (重要) / P2 (一般)
**发现时间：** YYYY-MM-DD HH:MM (请使用本地时间)
**发现人：** @[你的名字]
**模块：** 认证 / 药品 / 其他

---

### **问题简述**
*（用一句话清晰地描述问题，例如：“登录接口在密码错误时返回 500 错误，而不是预期的 401”）*

### **复现步骤**
1.  打开登录页面。
2.  输入邮箱：`doctor.test@tcm.com`
3.  输入错误的密码：`WrongPassword123`
4.  点击“登录”按钮。

### **期望结果**
*   API 应返回 HTTP 401 状态码。
*   响应体应为 `{ success: false, error: { code: 'AUTH_001', message: 'Invalid email or password.' ... } }`。
*   前端页面应显示“邮箱或密码错误”的提示。

### **实际结果**
*   API 返回了 HTTP 500 Internal Server Error。
*   前端页面显示通用的“服务器错误，请稍后重试”提示。

### **环境信息**
*   **浏览器：** Chrome 125.0.6422.142
*   **操作系统：** Windows 11 / macOS Sonoma
*   **API 端点：** `POST https://staging-api.tcm.onrender.com/api/v1/auth/login`
*   **测试账户：** `doctor.test@tcm.com`

### **附件 (截图、日志、网络请求详情)**
*   *（请在此处粘贴浏览器开发者工具“网络(Network)”标签页中，该 API 请求的完整截图，包括 Headers, Payload, 和 Response）*
*   *（请在此处粘贴任何相关的控制台错误日志截图）*

---
```
*   **附录 6.3 更新**
```
#!/bin/bash
set -e
# 使用环境变量，如果未设置则使用默认的 Staging URL
API_URL=${API_BASE_URL:-"https://staging-api.tcm.onrender.com/api/v1"}
TIMEOUT=10

echo "=== TCM Platform Health Check v1.1 ==="
# ... (其余脚本逻辑与架构师建议一致) ...
echo "🎉 All Health Checks Passed. Staging is READY!"
```
*   **附录 6.4 更新**
	- **实时日志流链接：** [链接到 Render.com Staging 服务的 Logs 页面]
    - **实时错误追踪 Dashboard：** [链接到 Sentry 项目的 Issues 页面]
    - **说明：** 联调期间，后端 Leader 将常驻这两个页面，实时监控 API 调用和错误情况。
*   **6.5 (新增) API 契约测试核心代码示例:** (采纳架构师提供的 PactumJS 示例作为参考)
	* - **6.5.1: auth.schema.json** - 包含 loginSuccess, loginError, meSuccess 等响应的完整 JSON Schema。
    - **6.5.2: medicines.schema.json** - 包含 medicinesListSuccess 响应的完整 JSON Schema。
	- PactumJS 示例代码将直接 require 或 import 这些 schema 文件进行验证。
*  **附录 6.6 更新):**
```
-- validation/data-quality-check.sql (v1.1)

-- 1. 检查药品数据完整性
SELECT 
  'DATA_QUALITY' AS category,
  'Medicines Table Integrity' AS check_item,
  CASE 
    WHEN COUNT(*) >= 50 AND COUNT(CASE WHEN "basePrice" IS NULL THEN 1 END) = 0 THEN 'PASS'
    ELSE 'FAIL'
  END AS status,
  json_build_object(
    'total', COUNT(*),
    'missing_prices', COUNT(CASE WHEN "basePrice" IS NULL THEN 1 END)
  )::text AS details
FROM public.medicines;

-- ... (其他检查项同样进行格式化) ...
```
**附录6.7更新**
明天联调开始前的检查清单
```bash
# 后端团队执行
□ 健康检查脚本测试通过
□ JSON Schema文件已提交并可访问
□ 数据质量检查脚本测试通过
□ 监控Dashboard链接已共享
□ 回滚步骤已文档化

# 前端团队执行  
□ 契约测试环境已准备就绪
□ JSON Schema文件已下载并集成
□ Plan B切换流程已测试
□ Slack通知机制已确认
```
---

### **最终行动指令 (今日内必须完成)**

**TO: 后端团队**

1. **立即更新 scripts/health-check.sh** 至增强版。
    
2. **立即创建并提交 auth.schema.json 和 medicines.schema.json** 到共享文档库。
    
3. **立即更新 validation/data-quality-check.sql** 至标准化输出格式。
    
4. **立即搭建并共享轻量级监控 Dashboard 的链接。**
    
5. **在 README.md 中增加一节“联调环境回滚步骤”。**
    

**TO: 前端团队**

1. **立即准备好契约测试环境 (PactumJS 或其他选定工具)。**
    
2. 在收到后端提供的 JSON Schema 文件后，**立即更新你们的契约测试脚本**，确保能够加载并使用这些 Schema 进行验证。
    
3. **熟悉并准备好你们的 Plan B** (一键切换回 Mock API) 流程。

**联调启动最终确认**

**联调将于明天上午 09:00 (NZST) 准时开始。**

- **08:30 - 09:00:** 后端执行最终版的健康检查和数据质量检查，并将结果发布。前端准备好运行契约测试。
    
- **09:00 - 09:45:** **API 契约测试必须 100% 通过，否则联调暂停。**