### **新西兰中医处方平台 - 前后端联调执行方案 v2.0 (DAY 1 正式启动版)**

**文档版本：** v2.0
**最后更新：** 2025年6月19日 21:30 NZST
**负责人：** 核心小组
**状态：** 🟢 **正式执行版 - 联调明日09:00启动**

---

#### **版本迭代说明**

**v2.0 基于 v1.9 的重大升级：**

✅ **契约测试完美达成：** 基于前后端双方确认，契约测试已于今晚21:20完成验证，响应格式测试9/9通过，端点连通性测试5/5通过，API完全兼容。

✅ **环境状态最终确认：** 后端API服务正常运行，前端apiClient.ts完全就绪，所有技术障碍已清零。

✅ **团队就绪状态：** 双方团队已完成所有准备工作，处于待命状态。

🚀 **v2.0 正式成为 DAY 1 联调执行的唯一指导文档。**

---

## **🎯 DAY 1 联调正式启动指令**

### **启动时间确认**
**联调正式启动：明日 2025年6月20日 09:00 NZST**

### **环境状态最终确认**
- **后端API服务：** 🟢 正常运行 (localhost:3000)
- **认证模块：** 🟢 /api/v1/auth/* 可用
- **药品模块：** 🟢 /api/v1/medicines 可用
- **数据库连接：** 🟢 正常
- **构建流程：** 🟢 无错误

### **团队就绪状态**
- **前端团队：** 🟢 契约测试100%通过，apiClient.ts就绪，Token管理机制完整
- **后端团队：** 🟢 API服务稳定运行，187个测试用例通过，适配层完成

---

## **📅 DAY 1 详细执行计划 (2025年6月20日)**

### **Phase 0: 联调启动前最终检查 (08:30 - 09:00)**

**🔧 后端团队任务：**
```bash
# 执行增强版健康检查
npm run health-check:staging
npm run data-quality:check
```

**验收标准：**
- ✅ API服务响应时间 < 200ms
- ✅ 数据库连接正常
- ✅ 核心端点返回200状态码
- ✅ 将检查结果截图发到Slack

**🎨 前端团队任务：**
- 验证本地开发环境
- 确认apiClient.ts配置正确
- 准备联调测试用例执行

### **Phase 1: 契约测试最终执行 (09:00 - 09:30)**

**🎨 前端团队主导：**
```bash
# 执行契约测试套件
npm test test/contract/
```

**必须达成标准：**
- ✅ 响应格式测试：9/9 通过
- ✅ 端点连通性测试：5/5 通过
- ✅ 执行时间 < 3秒

**⚠️ 关键节点：** 如契约测试未100%通过，联调立即暂停，后端团队1小时内修复

### **Phase 2: 认证模块核心联调 (09:30 - 12:30)**

#### **2.1 用户注册与登录流程 (09:30 - 10:30)**

**测试用例执行顺序：**

1. **TC-AUTH-01: 用户注册功能验证**
   ```javascript
   // 前端执行
   const registerData = {
     email: 'integration.test@tcm.nz',
     password: 'TestPass123!',
     name: '联调测试用户'
   };
   ```
   **验收标准：**
   - 注册成功返回user对象
   - 包含正确的id、email、role字段
   - 响应时间 < 500ms

2. **TC-AUTH-02: 用户登录功能验证**
   ```javascript
   // 前端执行
   const loginData = {
     email: 'integration.test@tcm.nz',
     password: 'TestPass123!'
   };
   ```
   **验收标准：**
   - 返回accessToken和refreshToken
   - Token格式符合JWT标准
   - user信息完整准确

3. **TC-AUTH-03: 获取用户信息功能验证**
   ```javascript
   // 使用获得的accessToken
   GET /api/v1/auth/me
   Authorization: Bearer <accessToken>
   ```
   **验收标准：**
   - 返回完整用户信息
   - 权限信息正确
   - 响应格式与契约一致

#### **2.2 Token管理机制测试 (10:30 - 12:30)**

4. **TC-AUTH-04: Token过期处理验证**
   - 模拟Token过期场景
   - 验证前端错误处理机制
   - 确认用户友好提示

5. **TC-AUTH-05: Token自动刷新功能验证**
   ```javascript
   // 前端apiClient.ts自动处理
   // 当accessToken即将过期时
   POST /api/v1/auth/refresh
   Authorization: Bearer <refreshToken>
   ```
   **验收标准：**
   - 自动刷新成功
   - 新Token立即可用
   - 用户无感知刷新

6. **TC-AUTH-06: 权限验证功能测试**
   - 测试不同角色的API访问权限
   - 验证403错误正确处理

### **午休时间 (12:30 - 13:15)**

### **Phase 3: 高级认证场景测试 (13:15 - 16:00)**

#### **3.1 并发与竞态条件测试 (13:15 - 14:30)**

7. **TC-AUTH-07: 并发Token刷新竞态条件测试**
   ```javascript
   // 模拟多个并发请求同时触发Token刷新
   const promises = Array(5).fill().map(() => 
     apiClient.get('/api/v1/auth/me')
   );
   await Promise.all(promises);
   ```
   **验收标准：**
   - 只发起一次refresh请求
   - 所有请求最终成功
   - 无重复刷新问题

8. **TC-AUTH-08: 异常Token处理测试**
   - 测试超长Token
   - 测试格式错误Token
   - 测试恶意Token

#### **3.2 错误场景与用户体验测试 (14:30 - 16:00)**

**P0级错误场景（必须测试）：**
- **网络超时：** 模拟API响应超时，验证前端超时处理
- **401未授权：** Token无效时的用户引导流程
- **403权限不足：** 权限错误的友好提示

**测试执行方式：**
```javascript
// 前端团队执行
// 1. 网络超时模拟
apiClient.timeout = 1000; // 设置1秒超时

// 2. 无效Token测试
apiClient.setToken('invalid.token.format');

// 3. 权限不足测试
// 使用低权限用户访问管理员API
```

### **Phase 4: 当日总结与准备 (16:00 - 17:30)**

#### **4.1 问题汇总与解决 (16:00 - 17:00)**
- 汇总当日发现的所有问题
- 分类：P0/P1/P2优先级
- 制定解决方案和时间表

#### **4.2 每日联调站会 (17:00 - 17:30)**
**参会人员：** 前后端核心小组
**会议议程：**
1. DAY 1成果汇报（5分钟）
2. 问题与风险识别（10分钟）
3. DAY 2药品模块联调计划确认（10分钟）
4. 资源与支持需求（5分钟）

---

## **🧪 测试用例详细规范**

### **认证模块测试用例清单**

| 用例ID | 测试名称 | 优先级 | 预期耗时 | 成功标准 |
|--------|----------|--------|----------|----------|
| TC-AUTH-01 | 用户注册功能验证 | P0 | 15分钟 | 注册成功，返回完整用户信息 |
| TC-AUTH-02 | 用户登录功能验证 | P0 | 15分钟 | 获得有效Token，用户信息正确 |
| TC-AUTH-03 | 获取用户信息功能验证 | P0 | 10分钟 | 返回完整准确的用户信息 |
| TC-AUTH-04 | Token过期处理验证 | P0 | 20分钟 | 过期Token被正确识别和处理 |
| TC-AUTH-05 | Token自动刷新功能验证 | P0 | 30分钟 | 自动刷新成功，用户无感知 |
| TC-AUTH-06 | 权限验证功能测试 | P1 | 20分钟 | 权限控制准确，错误提示友好 |
| TC-AUTH-07 | 并发Token刷新测试 | P1 | 25分钟 | 并发刷新无竞态条件问题 |
| TC-AUTH-08 | 异常Token处理测试 | P2 | 15分钟 | 异常Token被安全处理 |

### **错误场景测试规范**

**P0级错误场景（DAY 1必须完成）：**
1. **网络超时处理**
   - 模拟方式：设置短超时时间
   - 验证点：用户友好的超时提示
   - 成功标准：不出现技术错误信息

2. **Token过期处理**
   - 模拟方式：使用过期Token
   - 验证点：自动跳转登录页面
   - 成功标准：用户状态正确清理

3. **权限不足处理**
   - 模拟方式：低权限用户访问高权限API
   - 验证点：403错误的友好提示
   - 成功标准：不暴露敏感信息

---

## **⚠️ 风险管控与应急预案**

### **问题升级机制**

**P0问题处理时间线：**
- **0-15分钟：** Slack立即报告，双方Leader确认
- **15-60分钟：** 提供临时解决方案或workaround
- **1-2小时：** 根本原因修复并部署
- **2小时+：** 自动升级至架构师和产品经理

### **应急预案**

**1. API服务中断**
```javascript
// 前端立即执行Plan B
// 在apiClient.ts中
const API_BASE_URL = process.env.NODE_ENV === 'integration' 
  ? 'http://localhost:3001' // Mock服务器
  : 'http://localhost:3000'; // 真实API
```

**2. 数据库连接问题**
- 后端立即检查数据库连接
- 1小时内恢复服务
- 无法恢复则启用备份数据库

**3. 契约测试失败**
- 联调立即暂停
- 后端2小时内修复适配层
- 前端验证修复结果

### **回滚机制**
```bash
# 后端环境回滚
git checkout <last-stable-commit>
npm run deploy:staging

# 前端配置回滚
# 切换到Mock模式
export REACT_APP_API_MODE=mock
npm start
```

---

## **📊 成功指标与验收标准**

### **DAY 1成功指标**

**功能完整性：**
- ✅ 认证模块所有P0用例100%通过
- ✅ Token管理机制稳定运行
- ✅ 错误处理体验友好

**性能指标：**
- ✅ API响应时间P95 < 500ms
- ✅ Token刷新响应时间 < 200ms
- ✅ 页面加载时间 < 2秒

**稳定性指标：**
- ✅ 连续运行4小时无服务中断
- ✅ 并发测试无竞态条件
- ✅ 错误恢复机制100%有效

### **验收检查清单**

**后端团队验收：**
- [ ] API服务稳定运行8小时+
- [ ] 所有认证端点响应正常
- [ ] 数据库事务完整性
- [ ] 监控指标正常

**前端团队验收：**
- [ ] 所有测试用例执行完成
- [ ] 用户体验流程顺畅
- [ ] 错误处理机制完善
- [ ] 性能指标达标

**联合验收：**
- [ ] 端到端用户流程完整
- [ ] 数据交互100%兼容
- [ ] 无P0/P1级遗留问题
- [ ] DAY 2联调计划就绪

---

## **🚀 DAY 2 联调预告**

### **药品模块联调计划 (2025年6月21日)**

**主要目标：**
- 药品列表获取与展示
- 搜索功能完整测试
- 分页与排序功能验证
- 性能基准测试执行

**预期成果：**
- 药品模块功能100%可用
- 搜索性能达到亚秒级响应
- 分页机制稳定高效
- 用户体验流畅自然

---

## **📢 正式联调启动通知**

### **🎯 TO: 全体团队成员**

**联调正式启动确认：**
- **时间：** 明日 2025年6月20日 09:00 NZST
- **地点：** 各自工作地点 + Slack协作
- **状态：** 🟢 所有系统就绪，团队待命

**前端团队最终确认：**
- ✅ 契约测试：9/9 通过 (100%)
- ✅ 端点测试：5/5 通过 (100%)
- ✅ API兼容性：完美匹配
- ✅ 团队状态：100%就绪

**后端团队最终确认：**
- ✅ API服务：稳定运行
- ✅ 数据库：连接正常
- ✅ 测试套件：187个用例通过
- ✅ 团队状态：100%就绪

### **历史时刻**
经过三天的技术冲刺和一晚的契约验证，新西兰中医处方平台即将迎来前后端联调的历史时刻。

**明日09:00，让我们共同见证TCM平台的技术里程碑！** 🏆

### **联系方式**
- **紧急问题：** Slack #integration-channel
- **技术支持：** 核心小组成员随时在线
- **升级机制：** 2小时内无解决方案自动升级

---

**新西兰中医处方平台前后端联调 DAY 1**
**2025年6月20日 09:00 NZST**
**🚀 正式启动！**