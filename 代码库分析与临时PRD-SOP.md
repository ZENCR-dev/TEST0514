# 代码库分析与临时PRD/SOP
## 新西兰中医处方平台 - 代码库比对分析

### 📊 分析概览
- **分析时间**: 2024年12月19日
- **对比基准**: PRD MVP 0.5 (前端测试版)
- **代码库状态**: 已超出PRD范围，实现了MVP 0.8级别功能

---

## 🔍 代码库与PRD比对分析

### ✅ 符合PRD要求的功能

#### 1. 医生端 (Frontend Application) - 100%符合
**PRD要求**: FR1.1-FR1.5
- ✅ **FR1.1 商品查找与选择**: `src/components/prescription/MedicineSearch.tsx` - 完整实现
- ✅ **FR1.2 处方创建**: `src/pages/prescription/create.tsx` - 完整实现
- ✅ **FR1.3 价格计算与展示**: `src/utils/prescriptionCalculator.ts` - 完整实现
- ✅ **FR1.4 处方单生成与二维码**: `src/components/prescription/PrescriptionPreview.tsx` - 完整实现
- ✅ **FR1.5 处方单输出**: PDF生成和分享功能 - 完整实现

#### 2. 药房端 (Frontend Application) - 100%符合
**PRD要求**: FR3.1-FR3.4
- ✅ **FR3.1 界面适应性与摄像头访问**: `src/pages/pharmacy/scan.tsx` - 完整实现
- ✅ **FR3.2 二维码扫描与文本解析**: `src/components/pharmacy/QrScanner.tsx` - 完整实现
- ✅ **FR3.3 处方内容匹配与报价计算**: `src/utils/prescriptionCalculator.ts` - 完整实现
- ✅ **FR3.4 报价信息展示**: 药房端价格展示 - 完整实现

#### 3. 核心技术与数据 (内嵌前端) - 100%符合
**PRD要求**: FR4.1-FR4.2
- ✅ **FR4.1 内嵌数据**: `src/mocks/medicineData.ts` - 504种中药数据
- ✅ **FR4.2 二维码文本格式**: `src/utils/qrParser.ts` - 统一格式定义

#### 4. 合规要求 - 100%符合
- ✅ **测试版本标识**: `src/components/common/TestVersionBanner.tsx` - 完整实现
- ✅ **免责声明**: `src/components/common/ConsentModal.tsx` - 完整实现
- ✅ **模拟数据标注**: 所有Mock数据都有明确标识

---

## ❌ 不符合PRD要求的问题

### 1. 缺失的核心功能

#### 患者端功能 (FR2.1) - 0%实现
**PRD要求**: FR2.1 查找附近药房
- ❌ **缺失**: 公开的药房查找页面
- ❌ **缺失**: 地图集成 (Leaflet/Mapbox)
- ❌ **缺失**: 地理位置功能
- ❌ **缺失**: 药房位置数据和展示

**当前状态**: `src/pages/patient/index.tsx` 仅有空白页面

### 2. 超出PRD范围的功能

#### 管理员后台系统 - 完全超出范围
**PRD明确范围外**: "平台管理员后台界面"

**已实现但超出范围的功能**:
- ❌ **超范围**: `src/pages/admin/` - 完整的管理员系统
- ❌ **超范围**: `src/pages/admin/users/` - 用户管理功能
- ❌ **超范围**: `src/pages/admin/medicines/` - 药品管理功能
- ❌ **超范围**: `src/services/admin/` - 管理员服务层
- ❌ **超范围**: 用户注册登录系统 (PRD要求无需登录)

#### 扩展的药房功能 - 部分超出范围
- ❌ **超范围**: `src/pages/pharmacy/prescriptions.tsx` - 处方查询系统
- ❌ **超范围**: 处方状态管理功能
- ❌ **超范围**: 药房导航系统

---

## 🎯 临时PRD - 补完MVP 0.5

### 优先级1: 补完缺失的核心功能

#### 任务1: 患者端药房查找功能
**目标**: 实现PRD要求的FR2.1
**预计工期**: 2-3天

**具体需求**:
1. **页面创建**: `src/pages/pharmacy-finder.tsx` (公开页面，无需登录)
2. **地图集成**: 
   - 安装并配置Leaflet或Mapbox GL JS
   - 创建地图组件 `src/components/pharmacy-finder/PharmacyMap.tsx`
3. **地理位置功能**:
   - 浏览器地理位置API集成
   - 地址搜索功能
4. **药房数据**:
   - 创建 `src/mocks/pharmacyData.ts` - 少量药房位置信息
   - 药房列表组件 `src/components/pharmacy-finder/PharmacyList.tsx`
5. **UI/UX实现**:
   - 搜索框和"使用我的当前位置"按钮
   - 地图/列表视图切换
   - 移动端自适应设计

**技术栈**:
- Leaflet + React-Leaflet (推荐，轻量级)
- 或 Mapbox GL JS (功能更强大)

### 优先级2: 范围管理决策

#### 选项A: 保留扩展功能 (推荐)
**理由**: 
- 已投入大量开发工作
- 功能实现质量较高
- 可作为MVP 0.8版本继续开发

**行动**:
- 更新PRD版本为MVP 0.8
- 保留所有现有功能
- 继续完善交互逻辑

#### 选项B: 严格遵循PRD范围
**理由**: 
- 符合原始PRD设计
- 减少维护复杂度
- 专注核心验证目标

**行动**:
- 创建MVP 0.5分支
- 移除管理员功能
- 简化药房功能

### 优先级3: 功能完善

#### 任务2: 完善现有功能交互
**目标**: 提升用户体验
**预计工期**: 1-2天

1. **药房端报价单生成**:
   - 完善报价单确认流程
   - 添加打印和导出功能
2. **处方状态管理**:
   - 实现状态切换UI
   - 添加状态历史记录
3. **错误处理优化**:
   - 统一错误提示机制
   - 改善加载状态显示

---

## 📋 临时SOP - 开发执行计划

### 阶段1: 患者端药房查找 (2-3天)

#### Day 1: 基础设施搭建
- [ ] 安装地图库依赖 (`npm install leaflet react-leaflet`)
- [ ] 创建药房数据Mock (`src/mocks/pharmacyData.ts`)
- [ ] 创建基础页面结构 (`src/pages/pharmacy-finder.tsx`)
- [ ] 配置地图组件基础框架

#### Day 2: 核心功能实现
- [ ] 实现地理位置获取功能
- [ ] 实现地图显示和药房标记
- [ ] 实现药房列表展示
- [ ] 实现搜索功能

#### Day 3: UI/UX完善
- [ ] 实现地图/列表视图切换
- [ ] 移动端响应式优化
- [ ] 添加测试版本标识
- [ ] 功能测试和调试

### 阶段2: 范围决策执行 (1天)

#### 决策会议
- [ ] 评估选项A vs 选项B
- [ ] 确定项目版本定位 (MVP 0.5 vs MVP 0.8)
- [ ] 更新项目文档和README

### 阶段3: 功能完善 (1-2天)

#### 根据决策结果执行
**如果选择选项A (MVP 0.8)**:
- [ ] 完善管理员功能交互
- [ ] 完善药房端报价流程
- [ ] 添加处方状态管理

**如果选择选项B (MVP 0.5)**:
- [ ] 创建MVP 0.5分支
- [ ] 移除超范围功能
- [ ] 简化功能集

### 阶段4: 测试和部署 (0.5天)

- [ ] 全功能测试
- [ ] 移动端兼容性测试
- [ ] 部署到Vercel
- [ ] 更新文档

---

## 🚨 风险和建议

### 技术风险
1. **地图库集成复杂度**: Leaflet相对简单，Mapbox功能更强但配置复杂
2. **地理位置权限**: 需要HTTPS环境，本地开发可能受限
3. **移动端性能**: 地图组件可能影响移动端性能

### 项目风险
1. **范围蔓延**: 已经超出原始PRD范围，需要明确项目定位
2. **维护复杂度**: 功能越多，后续维护成本越高
3. **用户混淆**: 测试版本功能过多可能影响核心验证目标

### 建议
1. **优先完成患者端功能**: 这是PRD明确要求但缺失的核心功能
2. **明确项目定位**: 决定是继续MVP 0.8还是回归MVP 0.5
3. **保持测试标识**: 确保所有页面都有明确的测试版本标识
4. **文档同步更新**: 根据最终决策更新PRD和技术文档

---

## 📊 开发工作量估算

| 任务 | 优先级 | 预计工期 | 复杂度 | 风险等级 |
|------|--------|----------|--------|----------|
| 患者端药房查找 | P0 | 2-3天 | 中等 | 中等 |
| 范围决策执行 | P1 | 1天 | 低 | 低 |
| 功能完善 | P2 | 1-2天 | 低 | 低 |
| 测试和部署 | P3 | 0.5天 | 低 | 低 |

**总计**: 4.5-6.5天

---

**文档生成时间**: 2024年12月19日  
**分析基准**: PRD MVP 0.5 vs 当前代码库  
**建议执行**: 优先完成患者端功能，然后进行范围决策 