# 新西兰中医处方平台 - MVP0.8 PRD/SOP

## 版本信息
- **文档版本**: 0.8
- **基于代码库状态**: 2024年12月19日 (当前代码库)
- **目标阶段**: 纯前端 Demo 验证
- **编写者**: Gemini (AI Assistant)

---

## 1. 引言

本文档基于对当前新西兰中医处方平台代码库 (MVP 0.8 级别) 的全面分析，旨在定义"纯前端 Demo 验证"阶段的功能范围、技术实现（侧重 Mock）、开发计划和测试要点。当前代码库的功能已显著超出原始 MVP 0.5 前端测试版的定义，本文档将以现有代码为基础，规划补全缺失的关键功能，并完善现有功能的交互逻辑，以支持全面的前端 Demo 演示。

重要提示：本阶段 Demo 仍不涉及真实后端、数据库和敏感数据。所有数据均为前端模拟，仅用于功能演示和用户体验验证。

---

## 2. 当前代码库功能概览 (MVP 0.8 Baseline)

通过对代码库的全面审查，确认以下功能模块已在当前代码库中得到实现或部分实现，构成了 MVP 0.8 的基线功能集：

### 2.1. 已完全实现的核心功能 (继承自并完善 MVP 0.5)

- **认证与权限系统**: 基础的 JWT 模拟认证、角色识别和受保护路由。
- **QR 码扫描核心功能**: 基于 html5-qrcode 的摄像头扫描、多摄像头选择、扫描错误处理。
- **处方数据解析**: QR 码文本解析、数据结构和业务规则验证、药房端批发价计算。
- **医师处方创建**: 药品搜索、列表管理、用量帖数设置、处方预览、QR 码生成、PDF 导出。
- **基础数据管理**: 504 种中药模拟数据、用户数据模拟、基础药品搜索服务。
- **合规性模拟**: 测试版本标识 Banner、模拟同意模态框。

### 2.2. 已实现但超出原始 MVP 0.5 范围的功能 (MVP 0.8 特有)

这些功能模块在原始 MVP 0.5 PRD 中被列为"范围外"，但在当前代码库中已被实现或部分实现。考虑到其当前实现状态和对演示的潜在价值，将其纳入 MVP 0.8 Demo 范围。

#### 2.2.1. 管理员用户管理
- **状态**: UI: ~90%, 交互: ~60%
- **描述**: 提供了用户列表展示、搜索、过滤、详情查看和创建用户的 UI 界面。部分 Mock 服务已存在。缺少用户编辑、删除、批量操作和医生账户审核的完整前端交互及相应的 Mock 实现。
- **在 Demo 中的必要性**: 高。展示平台的多角色管理能力是 Demo 的重要组成部分。
- **技术栈**: Next.js, React, TypeScript, shadcn/ui (DataTable, Dialog, Form), react-hook-form, zod, Zustand, Mock Service (`src/services/admin/userService.ts`).

#### 2.2.2. 管理员药品管理
- **状态**: UI: ~80%, 交互: ~40%
- **描述**: 提供了中药列表展示、搜索、创建药品的 UI 界面。部分 Mock 服务已存在。缺少药品编辑、删除、批量导入/导出、分类管理和价格历史记录的完整前端交互及相应的 Mock 实现。
- **在 Demo 中的必要性**: 中等。展示药品基础数据管理能力。可以作为管理员功能的辅助演示。
- **技术栈**: Next.js, React, TypeScript, shadcn/ui (DataTable, Form), react-hook-form, zod, Mock Service (`src/services/medicineService.ts`).

#### 2.2.3. 药房处方管理 (扩展)
- **状态**: UI: ~70%, 交互: ~30%
- **描述**: 提供了药房处方查询界面框架。已实现了扫描处方后的详情展示和价格计算。缺少完整的处方列表展示、处方状态管理、报价单生成/提交流程、处方历史查看等功能。
- **在 Demo 中的必要性**: 高。这是药房端除扫描外的核心流程，是 Demo 的重要组成部分。
- **技术栈**: Next.js, React, TypeScript, shadcn/ui (DataTable, Input, Button), Zustand, Mock Service (`src/services/pharmacyService.ts` - 需要创建/完善).

#### 2.2.4. 医师工作站扩展功能
- **状态**: UI: ~30%, 交互: ~10%
- **描述**: 仅有基础页面框架和导航链接。患者管理、处方历史查看、病历管理、处方模板等功能完全缺失 UI 和 Mock 实现。
- **在 Demo 中的必要性**: 中等。可以增强医生端的演示内容，但非 MVP 0.8 核心流程。
- **技术栈**: Next.js, React, TypeScript, shadcn/ui, Mock Services (需要创建: `patientService.ts`, `prescriptionHistoryService.ts`).

#### 2.2.5. 用户注册登录系统
- **状态**: 基本实现
- **描述**: 实现了基本的登录/登出流程，使用 Mock 数据进行验证。虽然超出 MVP 0.5 要求无需登录，但作为多用户角色的 Demo 入口，已成为 MVP 0.8 基线的一部分。
- **在 Demo 中的必要性**: 高。是演示不同角色功能的入口。
- **技术栈**: Next.js, React, TypeScript, shadcn/ui, react-hook-form, zod, Mock Service (`src/services/authService.ts`).

---

## 3. 待开发功能模块 (MVP 0.8 纯前端 Demo)

本节列出为完成 MVP 0.8 纯前端 Demo 验证阶段所需补全和完善的功能模块。这些任务是基于对当前代码库和 MVP 0.8 报告的分析得出的。

### 3.1. 必须补全的核心缺失功能 (优先级 P0)

#### 3.1.1. 患者端药房查找
- **描述**: 实现一个公开页面，允许患者查找附近的合作药房。包括地图展示和列表展示，支持地理位置获取和地址搜索。
- **理由**: 这是原始 MVP 0.5 PRD 中明确要求但当前完全缺失的核心功能 (FR2.1)，是连接患者与药房的关键环节。
- **UI/UX**: 简洁直观的地图和列表视图，易于在移动端使用。
- **技术栈**: Next.js, React, TypeScript, 地图库 (如 Leaflet + React-Leaflet), 浏览器地理位置 API, Mock Data (`src/mocks/pharmacyData.ts`).
- **测试要点**: 地图加载、药房标记显示、地理位置获取、地址搜索、列表展示、地图/列表切换、移动端适配。

### 3.2. 需要完善交互和 Mock 的现有功能 (优先级 P1)

#### 3.2.1. 药房处方管理完善
- **描述**: 完善药房处方列表展示（模拟数据）、实现处方状态切换（如待处理 -> 处理中 -> 待配发 -> 已完成）、实现报价单生成预览和提交的 Mock 流程、添加处方历史查看页面框架。
- **理由**: 完善药房端核心工作流程，使其在 Demo 中更完整和可信。
- **UI/UX**: 清晰的状态标识和操作按钮，顺畅的报价单流程模拟。
- **技术栈**: Next.js, React, TypeScript, shadcn/ui (DataTable, Dialog), Zustand, Mock Service (`src/services/pharmacyService.ts`).
- **测试要点**: 处方列表加载、状态切换流程、报价单生成/提交模拟、历史页面导航。

#### 3.2.2. 管理员用户管理完善
- **描述**: 实现用户编辑和删除的 Mock 交互（模态框/表单和确认对话框），完善医生账户审核的 UI 和 Mock 流程。
- **理由**: 使已有的用户管理功能在 Demo 中更具操作性。
- **UI/UX**: 易于操作的编辑/删除流程，清晰的审核界面。
- **技术栈**: Next.js, React, TypeScript, shadcn/ui (Dialog, Form), react-hook-form, zod, Mock Service (`src/services/admin/userService.ts`).
- **测试要点**: 用户编辑/删除模拟、医生审核模拟流程。

#### 3.2.3. 管理员药品管理完善
- **描述**: 实现药品编辑和删除的 Mock 交互。
- **理由**: 使已有的药品管理功能具备基本的 CRUD 操作演示能力。
- **UI/UX**: 药品编辑表单和删除确认。
- **技术栈**: Next.js, React, TypeScript, shadcn/ui (Dialog, Form), react-hook-form, zod, Mock Service (`src/services/medicineService.ts`).
- **测试要点**: 药品编辑/删除模拟。

### 3.3. 可选功能完善 (优先级 P2)

#### 3.3.1. 医师工作站扩展 (患者/历史/模板)
- **描述**: 实现患者列表/详情的 Mock 页面和交互、处方历史查看页面框架、处方模板列表/编辑页面框架。
- **理由**: 丰富医生端 Demo 内容。
- **技术栈**: Next.js, React, TypeScript, shadcn/ui, Mock Services (`patientService.ts`, `prescriptionHistoryService.ts`).
- **测试要点**: 患者列表/详情导航、处方历史导航、模板列表导航。

#### 3.3.2. 报告和统计功能框架
- **描述**: 在管理员仪表盘或独立页面中，使用 Mock 数据和图表库展示基础统计信息（如用户数、处方数）。
- **理由**: 增强管理员端 Demo 的可视化效果。
- **技术栈**: Next.js, React, TypeScript, 图表库 (如 Recharts), Mock Data.
- **测试要点**: 仪表盘加载、图表显示。

#### 3.3.3. 通知和消息系统框架
- **描述**: 实现顶部导航的通知图标（模拟新通知计数）、简单的通知列表下拉菜单或页面框架。
- **理由**: 模拟平台内部通信机制。
- **技术栈**: Next.js, React, TypeScript, Zustand, shadcn/ui.
- **测试要点**: 通知图标显示、下拉菜单/页面导航。

#### 3.3.4. 高级搜索和过滤框架
- **描述**: 在现有列表页面（如药品、处方、用户列表）添加高级搜索/过滤的 UI 入口和模态框/区域框架，但不实现完整的多条件过滤逻辑（Mock 数据过滤）。
- **理由**: 展示高级搜索的可能性。
- **技术栈**: Next.js, React, TypeScript, shadcn/ui (Dialog/Sheet), react-hook-form.
- **测试要点**: 高级搜索入口点击、模态框/区域显示。

---

## 4. 技术栈 (MVP 0.8 纯前端 Demo)

沿用现有技术栈，并强调前端 Mock 的实现。

- **前端框架**: Next.js 14.2.28 + React 18.3.1 + TypeScript 5.8.3
- **UI 组件**: shadcn/ui + Radix UI + Tailwind CSS 3.4.1
- **状态管理**: Zustand 4.5.2
- **表单处理**: React Hook Form + Zod 验证
- **Mock 数据/服务**: `src/mocks/`, `src/services/` 目录下的模拟数据和函数
- **QR 码**: html5-qrcode 2.3.8 (扫描), qrcode.react 4.2.0 (生成)
- **PDF**: jspdf 3.0.1 (生成)
- **工具**: ESLint, Prettier
- **测试**: Jest, React Testing Library (现有，MVP 0.8 Demo阶段可侧重手动验证)
- **地图**: Leaflet + React-Leaflet (推荐用于患者端)
- **部署**: Vercel

**纯前端 Mock 实现原则**:
- 所有 Mock 服务函数应返回 Promise，模拟异步 API 调用。
- Mock 数据应尽量丰富，覆盖不同场景（如不同角色用户、不同状态的处方）。
- 明确在 UI 中标注数据为模拟，避免混淆。
- 对于需要用户交互（如编辑、删除）的 Mock 功能，重点实现前端 UI 流程和状态更新，Mock 服务只需模拟成功/失败响应。

---

## 5. 标准操作程序 (SOP) - 开发执行计划

本 SOP 规划了完成 MVP 0.8 纯前端 Demo 验证阶段待开发任务的执行顺序。

### 阶段1: 补全核心缺失功能 (P0)
- **任务**: 实现患者端药房查找功能。
- **步骤**:
    - 安装地图库 (`leaflet`, `react-leaflet`).
    - 创建药房 Mock 数据 (`src/mocks/pharmacyData.ts`).
    - 创建患者端药房查找页面 (`src/pages/pharmacy-finder.tsx`).
    - 实现地图组件和药房标记。
    - 实现地理位置获取和地址搜索。
    - 实现药房列表展示。
    - 实现地图/列表视图切换。
    - 完善 UI/UX 和移动端适配。
    - 添加测试版本标识。
    - 进行功能测试。
- **预计耗时**: 2-3天

### 阶段2: 完善现有功能交互 (P1)
- **任务**: 完善药房处方管理、管理员用户管理、管理员药品管理功能交互。
- **步骤**:
    - **药房处方管理**: 完善处方列表 UI (使用模拟数据)、实现状态切换 UI 和 Mock 服务、实现报价单生成/提交 Mock 流程、创建处方历史页面框架。
    - **管理员用户管理**: 实现用户编辑/删除的模态框/表单和 Mock 服务、完善医生审核 Mock 流程。
    - **管理员药品管理**: 实现药品编辑/删除的模态框/表单和 Mock 服务。
    - 为以上功能添加测试版本标识。
    - 进行功能测试。
- **预计耗时**: 2-3天

### 阶段3: 可选功能完善 (P2)
- **任务**: 实现医师工作站扩展、报告统计框架、通知消息框架、高级搜索框架。
- **步骤**:
    - **医师工作站**: 创建患者/历史/模板页面框架和基础 Mock 服务。
    - **报告统计**: 在仪表盘添加模拟统计图表。
    - **通知消息**: 实现通知图标和基础列表 UI。
    - **高级搜索**: 添加高级搜索 UI 入口和模态框框架。
    - 为以上功能添加测试版本标识。
    - 进行功能测试。
- **预计耗时**: 2-3天 (可选)

### 阶段4: 全面测试与部署
- **任务**: 进行 Demo 的全面测试，优化用户体验，最终部署。
- **步骤**:
    - 对所有已实现和完善的功能进行端到端手动测试。
    - 确保所有流程顺畅，Mock 数据按预期工作。
    - 检查 UI/UX 和响应式设计。
    - 验证测试版本标识和免责声明。
    - 修复发现的问题。
    - 部署应用到 Vercel。
    - 更新 README 文档，说明 Demo 功能和访问方式。
- **预计耗时**: 1天

**总预计开发耗时**: ~5-7天 (不含可选功能)

---

## 6. 测试用例 (纯前端 Demo)

本节列出进行纯前端 Demo 验证时应执行的关键测试场景。

### 6.1. 医生端测试用例
- [ ] 成功登录医生账户 (Mock)
- [ ] 搜索药品，选择药品并添加到处方列表
- [ ] 调整处方列表中药品的数量
- [ ] 从处方列表中移除药品
- [ ] 设置处方帖数
- [ ] 输入医嘱
- [ ] 设置处方费
- [ ] 查看处方总价（零售、含处方费）
- [ ] 生成处方单，预览处方详情
- [ ] 在预览页面查看 QR 码
- [ ] 模拟下载 PDF (检查模拟提示)
- [ ] 模拟分享处方单 (检查模拟提示)
- [ ] 完成处方，清空列表
- [ ] 验证测试版本标识始终可见

### 6.2. 药房端测试用例
- [ ] 成功登录药房账户 (Mock)
- [ ] 首次访问显示同意模态框，同意后不再显示
- [ ] 进入扫描处方页面
- [ ] 启动摄像头（如果环境允许）
- [ ] 使用生成的 QR 码进行扫描
- [ ] 扫描成功后，解析出处方内容
- [ ] 查看处方药品列表和数量
- [ ] 查看计算出的药房批发总价
- [ ] 验证测试版本标识始终可见
- [ ] （如果实现）进入处方查询页面，查看模拟处方列表
- [ ] （如果实现）尝试切换处方状态 (Mock 交互)
- [ ] （如果实现）尝试生成/提交报价单 (Mock 交互)

### 6.3. 患者端测试用例
- [ ] 访问药房查找公开页面
- [ ] 尝试使用当前位置查找药房 (如果环境允许)
- [ ] 手动输入地址或邮编进行搜索
- [ ] 在地图上查看药房位置标记
- [ ] 在列表中查看药房信息
- [ ] 切换地图和列表视图
- [ ] 验证测试版本标识始终可见
- [ ] （如果实现）成功登录患者账户 (Mock)
- [ ] （如果实现）查看模拟处方列表
- [ ] （如果实现）查看模拟就诊历史

### 6.4. 管理员端测试用例
- [ ] 成功登录管理员账户 (Mock)
- [ ] 进入用户管理页面
- [ ] 查看用户列表 (模拟数据)
- [ ] 尝试搜索和过滤用户 (Mock 交互)
- [ ] 尝试创建新用户 (Mock 交互)
- [ ] 尝试编辑现有用户 (Mock 交互，检查模态框/表单)
- [ ] 尝试删除用户 (Mock 交互，检查确认对话框)
- [ ] （如果实现）尝试批准医生账户 (Mock 交互)
- [ ] （如果实现）进入药品管理页面，查看模拟药品列表
- [ ] （如果实现）尝试编辑/删除药品 (Mock 交互)
- [ ] 验证测试版本标识始终可见

### 6.5. 通用测试用例
- [ ] 在不同分辨率和设备上测试页面的响应式布局。
- [ ] 验证所有表单的客户端基本验证 (通过 react-hook-form/zod)。
- [ ] 测试加载状态和错误提示 (基于 Mock 服务的模拟延迟和错误)。
- [ ] 验证 Mock 数据是否按预期显示。

---

## 7. 风险与建议

### 7.1. 技术风险
- **地图库集成**: Leaflet 相对简单，但特定功能可能需要额外插件。Mapbox 功能强大但配置和授权可能复杂。
- **地理位置权限**: 浏览器权限限制可能影响本地开发和演示环境。
- **Mock 数据局限性**: 纯前端 Mock 无法模拟复杂的后端业务逻辑和数据关联， Demo 仅能验证 UI 和前端流程。
- **性能**: 大量 Mock 数据和复杂前端渲染可能影响低端设备性能。

### 7.2. 项目风险
- **范围蔓延**: MVP 0.8 已经超出原始定义，后续迭代需要明确真实范围和优先级。
- **用户对 Mock 的理解**: 需要清晰告知用户这是一个纯前端 Demo，数据非真实，避免误解。
- **技术债务**: 为实现 Mock 功能而编写的代码可能在对接真实后端时需要重构。

### 7.3. 建议
- **优先完成核心功能**: 确保患者端药房查找功能能按期完成。
- **明确沟通 Demo 范围**: 在 Demo 前和过程中，反复强调这是纯前端模拟，数据不真实。
- **最小化非核心 Mock 工作量**: 严格按照本 PRD 规划的任务进行开发，避免在非核心功能上投入过多时间。
- **为后端集成做准备**: 在编写 Mock 服务时，代码结构应考虑未来替换为真实 API 调用。
- **尽早决策后端技术栈**: 明确后端方向有助于指导前端 Mock API 的设计。

---

## 附录：与原始 MVP 0.5 PRD 的差异

MVP 0.8 在 MVP 0.5 的基础上，主要增加了管理员系统（用户、药品管理）、药房处方查询/状态管理、用户注册登录系统、以及医师工作站的部分框架。同时，原始 MVP 0.5 中要求的患者端药房查找功能在当前 MVP 0.8 代码库中缺失，是本次迭代需要优先补齐的核心任务。

---

## 8. 最新进度更新 (2024年12月19日)

### 8.1. 当前完成状态概览
基于最新代码库分析和开发进度评估，当前整体完成度为 **85%**，具体分布如下：

#### 8.1.1. 已完全实现的功能（100%）
- ✅ **认证与权限系统**: JWT模拟认证、角色识别、受保护路由
- ✅ **QR码扫描核心功能**: 摄像头扫描、多摄像头选择、错误处理
- ✅ **处方数据解析**: QR码解析、数据验证、价格计算
- ✅ **医师处方创建**: 药品搜索、处方管理、QR码生成、PDF导出（95%）
- ✅ **基础数据管理**: 504种中药数据、用户数据、搜索服务（90%）

#### 8.1.2. 部分实现的功能
- 🔄 **管理员用户管理**: UI 90%, 交互 60% - 缺少编辑/删除/审核功能
- 🔄 **管理员药品管理**: UI 80%, 交互 40% - 缺少CRUD操作完善
- 🔄 **药房处方管理**: UI 70%, 交互 30% - 缺少状态管理和报价流程
- 🔄 **医师工作站扩展**: UI 30%, 交互 10% - 患者管理、历史等功能缺失

#### 8.1.3. 基本完成但需要完善的功能（85%）
- ✅ **患者端药房查找**: **重要发现 - 已基本实现85%**
  - ✅ 完整的pharmacy-finder.tsx页面
  - ✅ Leaflet地图集成（MapWrapper + LeafletMap组件）
  - ✅ 地理位置获取和药房搜索功能
  - ✅ PharmacyLocationService完整实现
  - ✅ 地图/列表视图切换
  - ✅ 响应式设计和错误处理
  - 🔄 需要测试验证和细节优化（15%待完成）

#### 8.1.4. 完全缺失的功能（0%）
- ❌ **患者端其他功能**: 注册、处方查看等（药房查找已实现）
- ❌ **报告统计**: 仪表盘、数据分析
- ❌ **通知消息**: 实时通知、消息中心
- ❌ **高级搜索**: 多条件搜索、保存搜索

### 8.2. 关键发现：PRD需求偏差修正
通过对照原始PRD需求，发现重大偏差修正：
- **✅ 已实现**: 患者端药房查找功能（原PRD FR2.1要求）- **85%完成度**
- **⚠️ 范围扩展**: 实现了大量超出原MVP 0.5范围的管理员功能
- **📈 影响**: 当前实现基本符合原始需求，主要任务转为完善管理功能

### 8.3. 患者端页面完善需求分析（修正版）

#### 8.3.1. 药房查找功能状态修正
**状态**: **已基本实现（85%）** ← 修正：之前误判为0%
**原PRD要求**: FR2.1 - 公开的药房查找页面，支持地图和地理位置 ✅
**实现质量**: 高 - 包含完整的Leaflet集成、地理位置、搜索功能
**剩余工作**:
- 功能测试和验证（5%）
- 用户体验优化（5%）
- 数据完善（5%）

#### 8.3.2. 扩展功能需求
**患者注册/登录**: 已有基础框架，需要完善
**处方查看**: 需要创建患者端处方历史页面
**药房选择**: 集成到处方流程中

#### 8.3.3. 完善程度评估（修正版）
患者端页面需要**适度完善**：
- 药房查找功能：从85%到100%（测试和优化）
- 患者注册流程：从20%到90%
- 处方查看功能：从0%到80%
- 整体患者体验：从85%到95%

### 8.4. 下一阶段执行计划 (修正版)

#### 阶段1: 完善现有功能交互层 (P0 - 最高优先级)
**预计时间**: 3-4天
**关键任务**:
1. **管理员用户管理**: 完善编辑/删除/审核Mock交互（60%→100%）
2. **药品管理系统**: 完善CRUD操作Mock交互（40%→100%）
3. **药房处方管理**: 完善状态管理和报价流程（30%→100%）

**理由**: 这些功能UI已基本完成，主要缺少交互逻辑，是提升整体完成度的最高效路径

#### 阶段2: 患者端药房查找功能验证和优化 (P1)
**预计时间**: 1天
**关键任务**:
1. 测试现有pharmacy-finder页面功能
2. 验证地图显示、搜索、定位功能
3. 优化用户体验和修复发现的bug
4. 完善Mock数据

**成功标准**:
- 地图正常显示药房位置
- 地理位置获取正常工作
- 搜索和筛选功能正确
- 移动端体验良好

#### 阶段3: 用户体验优化 (P2)
**预计时间**: 1-2天
**关键任务**:
1. 响应式设计全面优化
2. 错误处理和加载状态完善
3. 整体测试和bug修复
4. 性能优化

### 8.5. 项目完成度目标（修正版）
通过以上三个阶段的开发，预期将项目完成度从当前的**85%**提升至**98%**：
- 核心功能完成度：95% → 100%
- 管理功能完成度：60% → 95%
- 患者端功能完成度：85% → 95%
- 整体用户体验：80% → 95%

### 8.6. 风险与依赖（修正版）
**主要风险**:
- 管理功能的Mock交互实现可能遇到状态管理复杂性
- 现有药房查找功能可能存在未发现的bug
- Mock数据的真实性和完整性需要验证

**关键依赖**:
- 现有Leaflet地图集成的稳定性
- 管理功能UI组件的可扩展性
- Mock服务的数据一致性

---

**进度更新时间**: 2024年12月19日（重要发现：患者端药房查找功能已基本实现）
**下次评估时间**: 完成阶段1后进行中期评估

---

**文档生成时间**: 2024年12月19日 